%% Users manual for C++ BOUT code

\documentclass[12pt]{article}
\usepackage[nofoot]{geometry}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{hyperref}

\usepackage{listings}
\usepackage{color}
\usepackage{textcomp}
\usepackage{amsmath}

% Add an index
\usepackage{makeidx}
\makeindex

\definecolor{listinggray}{gray}{0.9}
\definecolor{lbcolor}{rgb}{0.95,0.95,0.95}
\lstset{
	backgroundcolor=\color{lbcolor},
        language=C++,
	keywordstyle=\bfseries\ttfamily\color[rgb]{0,0,1},
	identifierstyle=\ttfamily,
	commentstyle=\color[rgb]{0.133,0.545,0.133},
	stringstyle=\ttfamily\color[rgb]{0.627,0.126,0.941},
	showstringspaces=false,
	basicstyle=\small,
	numberstyle=\footnotesize,
	numbers=left,
	stepnumber=1,
	numbersep=10pt,
	tabsize=2,
	breaklines=true,
	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
	breakatwhitespace=false,
	aboveskip={0.5\baselineskip},
        columns=fixed,
        upquote=true,
        extendedchars=true,
        morekeywords={Field2D,Field3D,Vector2D,Vector3D,real,FieldGroup},
}

%% Modify margins
\addtolength{\oddsidemargin}{-.25in}
\addtolength{\evensidemargin}{-.25in}
\addtolength{\textwidth}{0.5in}
\addtolength{\textheight}{0.25in}
%% SET HEADERS AND FOOTERS

\pagestyle{fancy}
\fancyhf{}
\lhead{\rightmark}
\rhead{\thepage}
\renewcommand{\sectionmark}[1]{\markright{#1}{}}
\renewcommand{\headrulewidth}{0.3pt}
\setlength{\headheight}{15pt} 		% Avoids getting warning about to small
					% header

\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\bfile}[1]{\texttt{\bf 1}}
\newcommand{\defi}[4]{\int_{#1}^{#2} {#3} \; \text{d} {#4}} %Definite integral

%% commands for boxes with important notes
\newlength{\notewidth}
\addtolength{\notewidth}{\textwidth}
\addtolength{\notewidth}{-3.\parindent}
\newcommand{\note}[1]{
\fbox{
%
\begin{minipage}{\notewidth}
{\bf NOTE}: #1
\end{minipage}
%
}}

\def\L{\left}
\def\R{\right}
\newcommand{\rbtsq}{\ensuremath{\L(R\Bp\R)^2}}
\newcommand{\sbt}{\ensuremath{\sigma_{B\theta}}}
\newcommand{\apar}{\ensuremath{A_{||}}}
\newcommand{\pow}{\ensuremath{\wedge} }
\newcommand{\poweq}{\ensuremath{\wedge =} }
\newcommand{\dd}[2]{\ensuremath{\frac{d #1}{d #2}}}
\newcommand{\ddd}[2]{\ensuremath{\frac{d^2 #1}{d #2^2}}}
\newcommand{\deriv}[2]{\ensuremath{\frac{\partial #1}{\partial #2}}}
\newcommand{\dderiv}[2]{\ensuremath{\frac{\partial^2 #1}{\partial {#2}^2}}}
\newcommand{\Vpar}{\ensuremath{V_{||}}}
\newcommand{\Grad}{\ensuremath{\nabla}}
\newcommand{\Gradpar}{\ensuremath{\partial_{||}}}
\newcommand{\Divpar}{\ensuremath{\nabla_{||}}}
\newcommand{\DivXnablaX}[2]{\ensuremath{\nabla_\psi\L(#1\partial_\psi#2\R)}}
\newcommand{\DivParGradPar}[2]{\ensuremath{\nabla_{||}\L(#1\partial_{||}#2\R)}}
\newcommand{\hthe}{\ensuremath{h_\theta}}
\newcommand{\Bp}{\ensuremath{B_{\text{pol}}}}
\newcommand{\Bt}{\ensuremath{B_{\text{tor}}}}
\newcommand{\ve}[1]{\ensuremath{\boldsymbol{#1}}}
\newcommand{\hv}[1]{\hat{\ve{#1}}}
\newcommand{\bvec}{\ve{b}}
\newcommand{\kvec}{\ve{\kappa}}
\newcommand{\bxk}{\bvec\times\kvec\cdot\nabla}
\newcommand{\Bvec}{\ve{B}}
\newcommand{\Bbar}{\overline{B}}
\newcommand{\Tbar}{\overline{T}}
\newcommand{\Jvec}{\ve{J}}
\newcommand{\Jpar}{J_{||}}
\newcommand{\delp}{\nabla_\perp^2}
\newcommand{\Div}[1]{\ensuremath{\nabla\cdot #1 }}
\newcommand{\Curl}[1]{\ensuremath{\nabla\times #1 }}
\newcommand{\rbp}{\ensuremath{R\Bp}}
\newcommand{\rbpsq}{\ensuremath{\L(\rbp\R)^2}}
\newcommand{\Rvec}{\ensuremath{\hv{R}}}
\newcommand{\Zvec}{\ensuremath{\hv{Z}}}
\newcommand{\phivec}{\ensuremath{\hv{\phi}}}
\newcommand{\ehat}{\ensuremath{\hv{e}}}
\newcommand{\defined}{\ensuremath{\overset{\text{def}}{=}}}
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}
\allowdisplaybreaks
%
\begin{document}

\title{Field-aligned coordinates}
\author{B.Dudson\S, M.V.Umansky\dag, L.C.Wang\ddag, X.Q.Xu\dag,
L.L.LoDestro\dag \\
\\
  \S Department of Physics, University of York, UK \\
  \dag Lawrence Livermore National Laboratory, USA \\
  \ddag IFTS, China}
  \date{}
\maketitle

\tableofcontents





\section{Introduction}
%
This manual covers the field-aligned coordinate system used in many BOUT++
tokamak models, and useful derivations and expressions.





\section{Orthogonal toroidal coordinates}
%
\label{sec:coordinates}
Starting with an orthogonal toroidal coordinate system $\L(\psi, \theta,
\zeta\R)$, where $\psi$ is the poloidal flux, $\theta$ the poloidal angle
(from $0$ to $2\pi$), and $\zeta$ the toroidal angle (also $0$ to $2\pi$). We
have that the magnetic field $\Bvec$ can be expressed as
%
\begin{align*}
 \Bvec =& B_\theta \nabla \theta + B_\zeta \nabla \zeta\\ =& B_\theta
    \ve{e}_\theta + B_\zeta \ve{e}_\zeta\\ =& \Bp h_\theta \ve{e}_\theta + \Bt
    R \ve{e}_\zeta\\ =& \Bp \hv{e}_\theta + \Bt \hv{e}_\zeta
\end{align*}
%
The magnitudes of the unit vectors are
%
\begin{align*}
\L|\hv{e}_\psi\R| = \frac{1}{R\L|\Bp\R|} \qquad
\L|\hv{e}_\theta\R| = \hthe \qquad
\L|\hv{e}_\zeta\R| = R
\end{align*}
%
where $\hthe$ is the poloidal arc length per radian.  The coordinate system is
right handed, so $\hv{e}_\psi\times\hv{e}_\theta = \hv{e}_\zeta$,
$\hv{e}_\psi\times\hv{e}_\zeta = -\hv{e}_\theta$ and
$\hv{e}_\theta\times\hv{e}_\zeta = \hv{e}_\psi$. The covariant metric
coefficients are
%
\begin{align*}
g_{\psi\psi} = \frac{1}{\L(R\L|\Bp\R|\R)^2} \qquad
g_{\theta\theta} = h_\theta^2 \qquad g_{\zeta\zeta} = R^2
\end{align*}
%
and the magnitudes of the reciprocal vectors are therefore
%
\begin{align*}
\L|\nabla\psi\R| = R\L|\Bp\R| \qquad \L|\nabla\theta\R| =
\frac{1}{h_\theta} \qquad \L|\nabla\zeta\R| = \frac{1}{R}
\end{align*}
%
Because the coordinate system is orthogonal, $g^{ii} = 1/g_{ii}$ and so the
cross-products can be calculated as
%
\begin{align*}
\nabla\psi\times\nabla\theta = &\hv{e}^\psi\times \hv{e}^\theta =
    g^{\psi\psi}\ve{e}_\psi\times g^{\theta\theta}\ve{e}_\theta \nonumber \\ =
    & g^{\psi\psi}g^{\theta\theta}h_\psi h_\theta
    \hat{e}_\psi\times\hat{e}_\theta \nonumber \\ = &\frac{1}{h_\psi
h_\theta}\hv{e}_\zeta = \frac{R\L|\Bp\R|}{h_\theta}\hat{e}_\zeta
\end{align*}
%
Similarly,
%
\begin{align*}
\nabla\psi\times\nabla\zeta = -\L|\Bp\R|\hv{e}_\theta \qquad
\nabla\theta\times\nabla\zeta = \frac{1}{Rh_\theta}\hv{e}_\psi =
\frac{1}{h_\theta R^2\L|\Bp\R|}\nabla \psi
\end{align*}
%





\section{Field-aligned coordinates}
%
In order to efficiently simulate (predominantly) field-aligned structures,
grid-points are placed in a field-aligned coordinate system. We define
$\sigma_{B\theta} \equiv \Bp / \L|\Bp\R|$ i.e. the sign of the poloidal
field. The new coordinates $\L(x,y,z\R)$ are defined by:
%
\begin{align}
x = \sbt\L(\psi - \psi_0\R) \qquad y = \theta \qquad z =
\sigma_{B\theta} \L(\zeta -
\int_{\theta_0}^{\theta}\nu\L(\psi,\theta\R)d\theta\R)
\label{eq:coordtransform}
\end{align}
%
Where $\nu$ is the local field-line pitch given by
%
\begin{align*}
\nu\L(\psi, \theta\R) =
\frac{\Bvec\cdot\nabla\zeta}{\Bvec\cdot\nabla\theta} = \frac{\Bt\hthe}{\Bp R} =
\frac{\L(F/R\R)h_\theta}{\Bp R} = FJ/R^2
\end{align*}
%
where $F=\Bt R$ is a function only of $\psi$ (sometimes called the poloidal
current function).

The coordinate system is chosen so that $x$ increases radially outwards, from
plasma to the wall.  The sign of the toroidal field $\Bt$ can then be either +
or -.

The contravariant basis vectors are therefore
%
\begin{align*}
\nabla x = \sbt\nabla \psi \qquad \nabla y = \nabla \theta \qquad \nabla z =
\sbt\L(\nabla\zeta - \L[\int_{\theta_0}^\theta\deriv{\nu\L(\psi,
\theta\R)}{\psi} d\theta\R] \nabla\psi - \nu\L(\psi,
\theta\R)\nabla\theta\R)
\end{align*}
%
The term in square brackets is the integrated local shear:
%
\begin{align*}
I = \int_{y_0}^y\frac{\partial\nu\L(x, y\R)}{\partial\psi}dy
\end{align*}
%



\subsection{Magnetic field}
%
Magnetic field is given in Clebsch form by:
%
\begin{align*}
\Bvec = \nabla z\times \nabla x = \frac{1}{J}\ve{e}_y
\end{align*}
%
The contravariant components of this are then
%
\begin{align*}
B^y = \frac{\Bp}{\hthe} \qquad B^x = B^z = 0
\end{align*}
%
i.e. $\Bvec$ can be written as
%
\begin{align*}
\Bvec = \frac{\Bp}{\hthe}\ve{e}_y
\end{align*}
%
and the covariant components calculated using $g_{ij}$ as
%
\begin{align*}
B_x = \sbt\Bt I R \qquad B_y = \frac{B^2 \hthe}{\Bp} \qquad B_z = \sbt\Bt R
\end{align*}
%
The unit vector in the direction of equilibrium $\Bvec$ is therefore
%
\begin{align*}
\ve{b} = \frac{1}{JB}\ve{e}_y = \frac{1}{JB}\L[g_{xy}\nabla x + g_{yy}\nabla
y + g_{yz}\nabla z\R]
\end{align*}
%



\subsection{Jacobian and metric tensors}
%
The Jacobian of this coordinate system is
%
\begin{align*}
J^{-1} \equiv \L(\nabla x\times\nabla y\R)\cdot\nabla z = \Bp / \hthe
\end{align*}
%
which can be either positive or negative, depending on the sign of $\Bp$.  The
contravariant metric tensor is given by:
%
\begin{align*}
g^{ij} \equiv \ve{e}^i \cdot\ve{e}^j \equiv \nabla u^i \cdot \nabla u^j =
\L(%
\begin{array}{ccc}
\L(R\Bp\R)^2 & 0 & -I\L(R\Bp\R)^2 \\
0 & 1 / \hthe^2 & -\sbt\nu / \hthe^2 \\
-I\L(R\Bp\R)^2 & -\sbt\nu / \hthe^2 & I^2\L(R\Bp\R)^2 + B^2 /
\L(R\Bp\R)^2
\end{array}
%
 \R)
\end{align*}
%
and the covariant metric tensor:
%
\begin{align*}
g_{ij} \equiv \ve{e}_i \cdot\ve{e}_j = \L(%
\begin{array}{ccc}
I^2 R^2 + 1 / \rbpsq & \sbt\Bt\hthe I R / \Bp & I R^2 \\
\sbt\Bt\hthe I R / \Bp & B^2\hthe^2 / \Bp^2 & \sbt\Bt\hthe R / \Bp \\
I R^2 & \sbt\Bt\hthe R / \Bp & R^2
\end{array}
%
 \R)
\end{align*}
%



\subsection{Differential operators}
%
The derivative of a scalar field $f$ along the \emph{unperturbed} magnetic
field $\ve{b}_0$ is given by
%
\begin{align*}
\partial^0_{||}f \equiv \ve{b}_0 \cdot\nabla f =
\frac{1}{\sqrt{g_{yy}}}\deriv{f}{y} = \frac{\Bp}{B\hthe}\deriv{f}{y}
\end{align*}
%
whilst the parallel divergence is given by
%
\begin{align*}
\nabla^0_{||}f = B_0\partial^0_{||}\L(\frac{f}{B_0}\R)
\end{align*}
%
Using equation (\ref{eq:general_laplacian}), the Laplacian operator is given by
%
\begin{align*}
\nabla^2 = &\frac{\partial^2}{\partial x^2}\L|\nabla x\R|^2 +
    \frac{\partial^2}{\partial y^2}\L|\nabla y\R|^2 +
    \frac{\partial^2}{\partial z^2}\L|\nabla z\R|^2 \nonumber \\
    &-2\frac{\partial^2}{\partial x\partial z}I\L(R\Bp\R)^2 -
    2\frac{\partial^2}{\partial y\partial z}\frac{\nu}{h_\theta^2}\\
    &+\frac{\partial}{\partial x}\nabla^2x + \frac{\partial}{\partial
y}\nabla^2y + \frac{\partial}{\partial z}\nabla^2z \nonumber
\end{align*}
%
Using equation (\ref{eq:laplace_expand}) for $\nabla^2x = G^x$ etc, the
values are
%
\begin{align*}
\nabla^2x = \frac{\Bp}{h_\theta}\frac{\partial}{\partial x}\L(h_\theta
R^2\Bp\R) \qquad \nabla^2y = \frac{\Bp}{h_\theta}\frac{\partial}{\partial
y}\L(\frac{1}{\Bp h_\theta}\R)
\end{align*}
%
\begin{align*}
\nabla^2z = -\frac{\Bp}{h_\theta}\L[\frac{\partial}{\partial x}\L(IR^2\Bp
h_\theta\R) + \frac{\partial}{\partial y}\L(\frac{\nu}{\Bp
h_\theta}\R)\R]
\end{align*}
%
Neglecting some parallel derivative terms, the perpendicular Laplacian can be
written:
%
\begin{align*}
\delp = \rbpsq\L[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} +
\L(I^2 + \frac{B^2}{\L(\rbp\R)^4}\R)\dderiv{}{z}\R] +
\nabla^2 x \deriv{}{x} + \nabla^2 z\deriv{}{z}
\end{align*}
%
The second derivative along the equilibrium field
%
\begin{align*}
\partial^2_{||}\phi = \partial^0_{||}\L(\partial^0_{||}\phi\R) =
\frac{1}{\sqrt{g_{yy}}}\deriv{}{y}\L(\frac{1}{\sqrt{g_{yy}}}\R)\deriv{
\phi}{y} + \frac{1}{g_{yy}}\frac{\partial^2\phi}{\partial y^2}
\end{align*}
%
A common expression (the Poisson bracket in reduced MHD) is (from equation
(\ref{eq:brackets})):
%
\begin{align*}
\bvec_0\cdot\nabla\phi\times\nabla A =
\frac{1}{J\sqrt{g_{yy}}}\L[\L(g_{yy}\deriv{\phi}{z} -
    g_{yz}\deriv{\phi}{y}\R)\deriv{A}{x} + \L(g_{yz}\deriv{\phi}{x} -
    g_{xy}\deriv{\phi}{z}\R)\deriv{A}{y} + \L(g_{xy}\deriv{\phi}{y} -
g_{yy}\deriv{\phi}{x}\R)\deriv{A}{z}\R]
\end{align*}
%
The perpendicular nabla operator:
%
\begin{align*}
\nabla_\perp \equiv& \nabla - \ve{b}\L(\ve{b}\cdot\nabla\R) \\ =& \nabla
    x\L(\deriv{}{x} - \frac{g_{xy}}{\L(JB\R)^2}\deriv{}{y}\R) +
    \nabla z\L(\deriv{}{z} -
    \frac{g_{yz}}{\L(JB\R)^2}\deriv{}{y}\R)
\end{align*}
%



\subsection{\texorpdfstring{$J\times B$}{J x B} in field-aligned coordinates}
%
\label{sec:jxb_fac}
Components of the magnetic field in field-aligned coordinates:
%
\begin{align*}
B^y = \frac{\Bp}{\hthe} \qquad B^x = B^z = 0
\end{align*}
%
and
%
\begin{align*}
B_x = \sbt\Bt I R \qquad B_y = \frac{B^2\hthe}{\Bp} \qquad B_z = \sbt\Bt R
\end{align*}
%
Calculate current $\Jvec = \frac{1}{\mu}\Curl{\Bvec}$
%
\begin{align*}
\L(\Curl{\Bvec}\R)^x = \frac{1}{J}\L(\deriv{B_z}{y} -
\deriv{B_y}{z}\R) = 0
\end{align*}
%
since $\Bt R$ is a flux-surface quantity, and $\Bvec$ is axisymmetric.
%
\begin{align*}
\L(\Curl{\Bvec}\R)^y =& -\sbt\frac{\Bp}{\hthe}\deriv{}{x}\L(\Bt
R\R) \\ \L(\Curl{\Bvec}\R)^z =&
    \frac{\Bp}{\hthe}\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) -
    \sbt\deriv{}{y}\L(\Bt I R\R)\R]
\end{align*}
%
The second term can be simplified, again using $\Bt R$ constant on
flux-surfaces:
%
\begin{align*}
\deriv{}{y}\L(\Bt I R\R) = \sbt\Bt R\deriv{\nu}{x} \qquad \nu =
\frac{\hthe\Bt}{R\Bp}
\end{align*}
%
From these, calculate covariant components:
%
\begin{align}
\L(\Curl{\Bvec}\R)_x =& -\Bt I R \deriv{}{x}\L(\Bt R\R) +
    \frac{IR^2\Bp}{\hthe}\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) -
    \Bt R\deriv{\nu}{x}\R] \nonumber\\
%
\L(\Curl{\Bvec}\R)_y =& -\sbt\frac{B^2\hthe}{\Bp}\deriv{}{x}\L(\Bt
R\R) + \sbt\Bt R\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \Bt
R\deriv{\nu}{x}\R] \label{eq:curlb_y}\\
%
\L(\Curl{\Bvec}\R)_z =& -\Bt R\deriv{}{x}\L(\Bt R\R) +
\frac{R^2\Bp}{\hthe}\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \Bt
R\deriv{\nu}{x}\R] \nonumber
\end{align}
%
Calculate $\Jvec\times\Bvec$ using
%
\begin{align*}
\ve{e}^i = \frac{1}{J}\L(\ve{e}_j \times \ve{e}_k\R) \qquad \ve{e}_i =
J\L(\ve{e}^j \times \ve{e}^k\R) \qquad i,j,k \texttt{ cyc } 1,2,3
\end{align*}
%
gives
%
\begin{align*}
\mu_0 \L(\Jvec\times\Bvec\R)^x =&
    \frac{1}{J}\L[\L(\Curl{\Bvec}\R)_y B_z -
    \L(\Curl{\Bvec}\R)_z B_y \R]\\ =& -\frac{\Bp^3
    R^2}{\hthe}\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \Bt
    R\deriv{\nu}{x}\R]
\end{align*}
%
Covariant components of $\nabla P$:
%
\begin{align*}
\L(\nabla P\R)_x = \deriv{P}{x} \qquad \L(\nabla P\R)_y =
\L(\nabla P\R)_z = 0
\end{align*}
%
and contravariant:
%
\begin{align*}
\L(\nabla P\R)^x = \rbpsq\deriv{P}{x} \qquad \L(\nabla P\R)^y = 0
\qquad \L(\nabla P\R)^z = -I\rbpsq\deriv{P}{x}
\end{align*}
%
Hence equating contravariant x components of $\Jvec\times\Bvec = \nabla P$,
%
\begin{align}
\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \Bt
R\deriv{}{x}\L(\frac{\Bt\hthe}{R\Bp}\R) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{x} = 0
\label{eq:xbalance}
\end{align}
%
Use this to calculate $\hthe$ profiles (need to fix $\hthe$ at one radial
location).

Close to x-points, the above expression becomes singular, so a better way to
write it is:
%
\begin{align*}
\deriv{}{x}\L(B^2\hthe\R) - \hthe\Bp\deriv{\Bp}{x} - \Bt
R\deriv{}{x}\L(\frac{\Bt\hthe}{R}\R) + \mu_0\hthe\deriv{P}{x} = 0
\end{align*}
%
For solving force-balance by adjusting $P$ and $f$ profiles, the form used is
%
\begin{align*}
\Bt\hthe\deriv{\Bt}{x} + \frac{\Bt^2\hthe}{R}\deriv{R}{x} +
\mu_0\hthe\deriv{P}{x} = -\Bp\deriv{}{x}\L(\Bp\hthe\R)
\end{align*}
%
A quick way to calculate f is to rearrange this to:
%
\begin{align*}
\deriv{\Bt}{x} = \Bt\L[-\frac{1}{R}\deriv{R}{x}\R] +
\frac{1}{\Bt}\L[-\mu_0\deriv{P}{x} -
\deriv{\Bp}{\hthe}\deriv{}{x}\L(\Bp\hthe\R)\R]
\end{align*}
%
and then integrate this using LSODE.



\subsection{Parallel current}
%
\begin{align*}
J_{||} = \bvec\cdot\Jvec \qquad b^y = \frac{\Bp}{B\hthe}
\end{align*}
%
and from equation \ref{eq:curlb_y}:
%
\begin{align*}
J_y = \frac{\sbt}{\mu_0}\L\{-\frac{B^2\hthe}{\Bp}\deriv{}{x}\L(\Bt
R\R) + \Bt R\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \sbt\Bt
R\deriv{\nu}{x}\R]\R\}
\end{align*}
%
since $J_{||} = b^yJ_y$,
%
\begin{align*}
\mu_0 J_{||} =\sbt\frac{\Bp\Bt
R}{B\hthe}\L[\deriv{}{x}\L(\frac{B^2\hthe}{\Bp}\R) - \Bt
R\deriv{\nu}{x}\R] - \sbt B\deriv{}{x}\L(\Bt R\R)
\end{align*}
%



\subsection{Curvature}
%
For reduced MHD, need to calculate curvature term $\bvec\times\ve{\kappa}$,
where $\ve{\kappa} = \L(\bvec\cdot\nabla\R)\bvec =
-\bvec\times\L(\nabla\times\bvec\R)$. Re-arranging, this becomes:
%
\begin{align*}
\bvec\times\ve{\kappa} = \nabla\times\bvec -
\bvec\L(\bvec\cdot\L(\nabla\times\bvec\R)\R)
\end{align*}
%
Components of $\nabla\times\bvec$ are:
%
\begin{align*}
\L(\nabla\times\bvec\R)^x =&
    \sbt\frac{\Bp}{\hthe}\deriv{}{y}\L(\frac{\Bt R}{B}\R) \\
    \L(\nabla\times\bvec\R)^y =&
    -\sbt\frac{\Bp}{\hthe}\deriv{}{x}\L(\frac{\Bt R}{B}\R) \\
    \L(\nabla\times\bvec\R)^z =&
    \frac{\Bp}{\hthe}\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) -
    \sbt\frac{\Bp\Bt R}{\hthe B}\deriv{\nu}{x} - \sbt
    I\frac{\Bp}{\hthe}\deriv{}{y}\L(\frac{\Bt R}{B}\R) \\
\end{align*}
%
giving:
%
\begin{align}
\ve{\kappa} =& -\frac{\Bp}{B h_\theta}\L[\deriv{}{x}\L(\frac{B
h_\theta}{\Bp}\R) - \sbt\deriv{}{y}\L(\frac{\Bt I
R}{B}\R)\R]\nabla x \nonumber \\ &+ \sbt\frac{\Bp}{B
    h_\theta}\deriv{}{y}\L(\frac{\Bt R}{B}\R)\nabla z
\label{eq:curvature}
\end{align}
%
\begin{align*}
\bvec\cdot\L(\nabla\times\bvec\R) = -\sbt B\deriv{}{x}\L(\frac{\Bt
R}{B}\R) + \sbt \frac{\Bt\Bp
R}{B\hthe}\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) - \frac{\Bp\Bt^2R^2}{\hthe
B^2}\deriv{\nu}{x}
\end{align*}
%
therefore,
%
\begin{align*}
\L(\bvec\times\ve{\kappa}\R)^x =&
    \sbt\frac{\Bp}{\hthe}\deriv{}{y}\L(\frac{\Bt R}{B}\R) =
    -\sbt\frac{\Bp\Bt R}{\hthe B^2}\deriv{B}{y} \\
    \L(\bvec\times\ve{\kappa}\R)^y =& \frac{\Bp^2\Bt^2
R^2}{B^3\hthe^2}\deriv{\nu}{x} - \sbt\frac{\Bp^2\Bt
R}{B^2\hthe^2}\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) \\
\L(\bvec\times\ve{\kappa}\R)^z =&
\frac{\Bp}{\hthe}\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) - \sbt\frac{\Bp\Bt
R}{\hthe B}\deriv{\nu}{x} - I\L(\bvec\times\ve{\kappa}\R)^x
\end{align*}
%
Using equation~\ref{eq:xbalance}:
%
\begin{align*}
B\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) + \frac{B\hthe}{\Bp}\deriv{B}{x} -
\sbt\Bt R\deriv{}{x}\L(\frac{\Bt\hthe}{R\Bp}\R) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{x} = 0
\end{align*}
%
we can re-write the above components as:
%
\begin{align*}
\L(\bvec\times\ve{\kappa}\R)^y =& \sbt\frac{\Bp\Bt
R}{B^2\hthe}\L[\frac{\mu_0}{B}\deriv{P}{x} + \deriv{B}{x}\R] \\
\L(\bvec\times\ve{\kappa}\R)^z =& -\frac{\mu_0}{B}\deriv{P}{x} -
\deriv{B}{x} - I\L(\bvec\times\ve{\kappa}\R)^x
\end{align*}
%



\subsection{Curvature from \texorpdfstring{$\nabla\times\L(\bvec /
B\R)$}{div (b/B)}} The vector $\bvec\times\kvec$ is an approximation of
%
\begin{align*}
\frac{B}{2}\nabla\times\L(\frac{\bvec}{B}\R) \simeq \bvec\times\kvec
\end{align*}
%
so can just derive from the original expression. Using the contravariant
components of $\bvec$, and the curl operator in curvilinear coordinates (see
appendix):

%
\begin{align*}
\nabla\times\L(\frac{\bvec}{B}\R) =&
    \frac{\Bp}{\hthe}\L[\L(\deriv{}{x}\L(\frac{\hthe}{\Bp}\R) -
        \deriv{}{y}\L(\frac{\sbt\Bt IR}{B^2}\R)\R)\ve{e}_z \R.
        \\ &+ \deriv{}{y}\L(\frac{\sbt\Bt R}{B^2}\R)\ve{e}_x \\ &+
    \L.\deriv{}{x}\L(\frac{\sbt\Bt R}{B^2}\R)\ve{e}_y\R]
\end{align*}
%
This can be simplified using
%
\begin{align*}
\deriv{}{y}\L(\frac{\sbt\Bt IR}{B^2}\R) = I\sbt\Bt
R\deriv{}{y}\L(\frac{1}{B^2}\R) + \frac{\Bt R}{B^2}\deriv{\nu}{x}
\end{align*}
%
to give
%
\begin{align*}
  \L(\bvec\times\kvec\R)^x =& -\sbt\frac{\Bp\Bt R}{\hthe
B^2}\deriv{B}{y} \\ \L(\bvec\times\kvec\R)^y =&
    -\sbt\frac{B\Bp}{2\hthe}\deriv{}{x}\L(\frac{\Bt R}{B^2}\R) \\
    \L(\bvec\times\kvec\R)^z =&
    \frac{B\Bp}{2\hthe}\deriv{}{x}\L(\frac{\hthe}{\Bp}\R) - \frac{\Bp\Bt
    R}{2\hthe B}\deriv{\nu}{x} - I\L(\bxk\R)^x
\end{align*}
%
The first and second terms in $\L(\bxk\R)^z$ almost cancel, so by
expanding out $\nu$ a better expression is
%
\begin{align*}
\L(\bvec\times\kvec\R)^z = \frac{\Bp^3}{2\hthe
B}\deriv{}{x}\L(\frac{\hthe}{\Bp}\R) - \frac{\Bt
R}{2B}\deriv{}{x}\L(\frac{\hthe}{\Bp}\R)
\end{align*}
%



\subsection{Curvature of a single line}
%
The curvature vector can be calculated from the field-line toroidal coordinates
$\L(R,Z,\phi\R)$ as follows. The line element is given by
%
\begin{align*}
d\ve{r} = dR\Rvec + dZ\Zvec + Rd\phi\phivec
\end{align*}
%
Hence the tangent vector is
%
\begin{align*}
\hv{T} \equiv \dd{\ve{r}}{s} = \dd{R}{s}\Rvec + \dd{Z}{s}\Zvec +
R\dd{\phi}{s}\phivec
\end{align*}
%
where $s$ is the distance along the field-line. From this, the curvature vector
is given by
%
\begin{align*}
\kvec \equiv \dd{\ve{T}}{s} =& \ddd{R}{s}\Rvec + \dd{R}{s}\dd{\phi}{s}\phivec
    \\ &+ \ddd{Z}{s}\Zvec \\ &+ \dd{R}{s}\dd{\phi}{s}\phivec +
    R\ddd{\phi}{s}\phivec - R\L(\dd{\phi}{s}\R)^2 \Rvec
\end{align*}
%
i.e.
%
\begin{align}
\kvec = \L[\ddd{R}{s} - R\L(\dd{\phi}{s}\R)^2\R]\Rvec +
\ddd{Z}{s}\Zvec + \L[2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\R]\phivec
\label{eq:kappaline}
\end{align}
%
Want the components of $\ve{b}\times\kvec$, and since the vector $\ve{b}$ is
just the tangent vector $\ve{T}$ above, this can be written using the
cross-products
%
\begin{align*}
\Rvec\times\Zvec = -\phivec \qquad \phivec\times\Zvec = \Rvec \qquad
\Rvec\times\phivec = \Zvec
\end{align*}
%
This vector must then be dotted with $\nabla\psi$, $\nabla\theta$, and
$\nabla\phi$. This is done by writing these vectors in cylindrical coordinates:
%
\begin{align*}
\nabla\psi =& \deriv{\psi}{R}\hv{R} + \deriv{\psi}{Z}\hv{Z} \\ \nabla\theta =&
    \frac{1}{\Bp\hthe}\nabla\phi\times\nabla\psi =
    \frac{1}{R\Bp\hthe}\L(\deriv{\psi}{Z}\hv{R} -
    \deriv{\psi}{R}\hv{Z}\R) \\
\end{align*}
%
An alternative is to use
%
\begin{align*}
\bvec \times \nabla\phi = \frac{\sbt}{BR^2}\nabla\psi
\end{align*}
%
and that the tangent vector $\ve{T} = \bvec$. This gives
%
\begin{align}
\nabla\psi = \sbt BR\L[\frac{dR}{ds}\ve{Z} - \frac{dZ}{ds}\ve{R}\R]
\label{eq:flinenablapsi}
\end{align}
%
and so because $d\phi / ds = \Bt / \L(RB\R)$
%
\begin{align}
\kvec\cdot\nabla\psi = \sbt BR\L[ \L( \frac{\Bt^2}{RB^2} -
\ddd{R}{s}\R)\dd{Z}{s} + \ddd{Z}{s}\frac{dR}{ds} \R]
\label{eq:flinekappsi}
\end{align}
%
Taking the cross-product of the tangent vector with the curvature in
equation~\ref{eq:kappaline} above gives
%
\begin{align*}
  \bvec \times\kvec =& \L[\frac{\Bt}{B}\ddd{Z}{s} -
\dd{Z}{s}\L(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\R)\R]\ve{R} \\
&+ \L[\dd{R}{s}\L(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\R) -
\frac{\Bt}{B}\L(\ddd{R}{s} -
R\L(\dd{\phi}{s}\R)^2\R)\R]\ve{Z} \\ &+
    \L[\dd{Z}{s}\L(\ddd{R}{s} - R\L(\dd{\phi}{s}\R)^2\R) -
    \dd{R}{s}\ddd{Z}{s}\R]\phivec
\end{align*}
%
The components in field-aligned coordinates can then be calculated:
%
\begin{align*}
\L(\bvec\times\kvec\R)^x =&
    \sbt\L(\bvec\times\kvec\R)\cdot\nabla\psi \\ =&
    \frac{R\Bp^2}{B}\L(2\dd{R}{s}\dd{\phi}{s} + R\ddd{\phi}{s}\R) -
    R\Bt\L(\dd{R}{s}\ddd{R}{s} + \dd{Z}{s}\ddd{Z}{s}\R) +
    \frac{\Bt^3}{B^2}\dd{R}{s}
\end{align*}
%



\subsection{Curvature in toroidal coordinates}
%
In toroidal coordinates $\L(\psi,\theta,\phi\R)$, the $\bvec$ vector is
%
\begin{align*}
\bvec =& \frac{\Bp}{B}\ehat_\theta + \frac{\Bt}{B}\ehat_\phi \\ =&
    \frac{\Bp\hthe}{B}\nabla\theta + \frac{R\Bt}{B}\nabla\phi
\end{align*}
%
The curl of this vector is
%
\begin{align*}
\L(\nabla\times\bvec\R)^\psi =&
    \frac{1}{\sqrt{g}}\L(\deriv{b_\phi}{\theta} -
    \deriv{b_\theta}{\phi}\R) \\ \L(\nabla\times\bvec\R)^\theta =&
        \frac{1}{\sqrt{g}}\L(\deriv{b_\psi}{\phi} -
        \deriv{b_\phi}{\psi}\R) \\ \L(\nabla\times\bvec\R)^\phi =&
            \frac{1}{\sqrt{g}}\L(\deriv{b_\theta}{\psi} -
            \deriv{b_\psi}{\theta}\R)
\end{align*}
%
where $1/\sqrt{g} = \Bp/\hthe$. Therefore, in terms of unit vectors:
%
\begin{align*}
\nabla\times\bvec =
\frac{1}{R\hthe}\deriv{}{\theta}\L(\frac{R\Bt}{B}\R)\ehat_\psi -
\Bp\deriv{}{\psi}\L(\frac{R\Bt}{B}\R)\ehat_\theta + \frac{\Bp
R}{\hthe}\deriv{}{\psi}\L(\frac{\hthe\Bp}{B}\R)\ehat_\phi
\end{align*}
%



\subsection{\texorpdfstring{$\psi$}{psi}
%
 derivative of the \texorpdfstring{$B$}{B} field} Needed to calculate magnetic
 shear, and one way to get the curvature.  The simplest way is to use finite
 differencing, but there is another way using local derivatives (implemented
 using DCT).
%
\begin{align*}
\Bp = \frac{\L|\nabla\psi\R|}{R} =
\frac{1}{R}\sqrt{\L(\deriv{\psi}{R}\R)^2 +
\L(\deriv{\psi}{R}\R)^2}
\end{align*}
%
Using
%
\begin{align*}
\nabla\Bp = \deriv{\Bp}{\psi}\nabla\psi + \deriv{\Bp}{\theta}\nabla\theta +
\deriv{\Bp}{\phi}\nabla\phi
\end{align*}
%
we get
%
\begin{align*}
\nabla\Bp \cdot\nabla\psi = \deriv{\Bp}{\psi}\L|\nabla\psi\R|^2
\end{align*}
%
and so
%
\begin{align*}
\deriv{\Bp}{\psi} = \nabla\Bp \cdot\nabla\psi / \L(R\Bp\R)^2
\end{align*}
%
The derivatives of $\Bp$ in $R$ and $Z$ are:
%
\begin{align*}
\deriv{\Bp}{R} =& -\frac{\Bp}{R} + \frac{1}{\Bp
R^2}\L[\deriv{\psi}{R}\dderiv{\psi}{R} +
\deriv{\psi}{Z}\frac{\partial^2\psi}{\partial R\partial Z}\R] \\
\deriv{\Bp}{Z} =& \frac{1}{\Bp R^2}\L[\deriv{\psi}{Z}\dderiv{\psi}{Z} +
\deriv{\psi}{R}\frac{\partial^2\psi}{\partial R\partial Z}\R]
\end{align*}
%
For the toroidal field, $\Bt = f/R$
%
\begin{align*}
\deriv{\Bt}{\psi} = \frac{1}{R}\deriv{f}{\psi} - \frac{f}{R^2}\deriv{R}{\psi}
\end{align*}
%
As above, $\deriv{R}{\psi} = \nabla R \cdot\nabla\psi / \L(R\Bp\R)^2$,
and since $\nabla R\cdot\nabla R = 1$,
%
\begin{align*}
\deriv{R}{\psi} = \deriv{\psi}{R} / \L(R\Bp\R)^2
\end{align*}
%
similarly,
%
\begin{align*}
\deriv{Z}{\psi} = \deriv{\psi}{Z} / \L(R\Bp\R)^2
\end{align*}
%
and so the variation of toroidal field with $\psi$ is
%
\begin{align*}
\deriv{\Bt}{\psi} = \frac{1}{R}\deriv{f}{\psi} -
\frac{\Bt}{R^3\Bp^2}\deriv{\psi}{R}
\end{align*}
%
From the definition $B=\sqrt{\Bt^2 + \Bp^2}$,
%
\begin{align*}
\deriv{B}{\psi} = \frac{1}{B}\L(\Bt\deriv{\Bt}{\psi} +
\Bp\deriv{\Bp}{\psi}\R)
\end{align*}
%



\subsection{Parallel derivative of the \texorpdfstring{$B$}{B} field}
%
To get the parallel nablaients of the $B$ field components, start with
%
\begin{align*}
\deriv{}{s}\L(B^2\R) = \deriv{}{s}\L(\Bt^2\R) +
\deriv{}{s}\L(\Bp^2\R)
\end{align*}
%
Using the fact that $R\Bt$ is constant along $s$,
%
\begin{align*}
\deriv{}{s}\L(R^2\Bt^2\R) = R^2\deriv{}{s}\L(\Bt^2\R) +
\Bt^2\deriv{}{s}\L(R^2\R) = 0
\end{align*}
%
which gives
%
\begin{align*}
  \deriv{}{s}\L(\Bt^2\R) = -\frac{\Bt^2}{R^2}\deriv{}{s}\L(R^2\R)
\end{align*}
%
The poloidal field can be calculated from
%
\begin{align*}
\deriv{}{s}\L(\nabla\psi \cdot \nabla\psi\R) =
\deriv{}{s}\L(R^2\Bp^2\R) = R^2\deriv{}{s}\L(\Bp^2\R) +
\Bp^2\deriv{}{s}\L(R^2\R)
\end{align*}
%
Using equation~\ref{eq:flinenablapsi}, $\nabla\psi \cdot \nabla\psi$ can also be
written as
%
\begin{align*}
\nabla\psi \cdot \nabla\psi = B^2R^2\L[\L(\deriv{R}{s}\R)^2 +
\L(\deriv{Z}{s}\R)^2\R]
\end{align*}
%
and so (unsurprisingly)
%
\begin{align*}
\frac{\Bp^2}{B^2} = \L[\L(\deriv{R}{s}\R)^2 +
\L(\deriv{Z}{s}\R)^2\R]
\end{align*}
%
Hence
%
\begin{align*}
\deriv{}{s}\L(\Bp^2\R) = B^2\deriv{}{s}\L[\L(\deriv{R}{s}\R)^2
+ \L(\deriv{Z}{s}\R)^2\R] +
\frac{\Bp^2}{B^2}\deriv{}{s}\L(B^2\R)
\end{align*}
%
Which gives
%
\begin{align*}
\deriv{}{s}\L(B^2\R) = -\frac{B^2}{R^2}\deriv{}{s}\L(R^2\R) +
\frac{B^4}{\Bt^2}\deriv{}{s}\L[\L(\deriv{R}{s}\R)^2 +
\L(\deriv{Z}{s}\R)^2\R]
\end{align*}
%
\begin{align*}
\deriv{}{s}\L(\Bp^2\R) = \L(1 +
\frac{\Bp^2}{\Bt^2}\R)B^2\deriv{}{s}\L[\L(\deriv{R}{s}\R)^2 +
\L(\deriv{Z}{s}\R)^2\R] -
\frac{\Bp^2}{R^2}\deriv{}{s}\L(R^2\R)
\end{align*}
%



\subsection{Magnetic shear from \texorpdfstring{$J\times B$}{J x B}}
%
Re-arranging the radial force balance equation~\ref{eq:xbalance} gives
%
\begin{align*}
\frac{\Bp^2R}{\Bt}\deriv{\nu}{\psi} + \nu\L(\frac{2RB}{\Bt}\deriv{B}{\psi} +
\frac{B^2}{\Bt}\deriv{R}{\psi} - \frac{B^2R}{\Bt^2}\deriv{\Bt}{\psi}\R) +
\frac{\mu_0\hthe}{\Bp}\deriv{P}{\psi} = 0
\end{align*}
%



\subsection{Magnetic shear}
%
The field-line pitch is given by
%
\begin{align*}
\nu = \frac{\hthe\Bt}{\Bp R}
\end{align*}
%
and so
%
\begin{align*}
\deriv{\nu}{\psi} = \frac{\nu}{\hthe}\deriv{\hthe}{\psi} +
\frac{\nu}{\Bt}\deriv{\Bt}{\psi} - \frac{\nu}{\Bp}\deriv{\Bp}{\psi} -
\frac{\nu}{R}\deriv{R}{\psi}
\end{align*}
%
The last three terms are given in the previous section, but
$\partial\hthe/\partial\psi$ needs to be evaluated



\subsection{\texorpdfstring{$\psi$}{psi}
%
 derivative of \texorpdfstring{$\hthe$}{h}} From the expression for curvature
 \ref{eq:curvature}, and using $\nabla x \cdot \nabla \psi = \sbt
 \L(R\Bp\R)^2$ and $\nabla z\cdot\nabla \psi = -\sbt I
 \L(R\Bp\R)^2$
%
\begin{align*}
\kvec\cdot\nabla\psi =& -\sbt
    \frac{\Bp}{B\hthe}\rbpsq\L[\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) -
    \sbt\deriv{}{y}\L(\frac{\Bt IR}{B}\R)\R] \\ &- I\rbpsq
        \frac{\Bp}{B\hthe}\deriv{}{y}\L(\frac{\Bt R}{B}\R)
\end{align*}
%
The second and third terms partly cancel, and using $\deriv{I}{y} = \sbt
\deriv{\nu}{x}$
%
\begin{align*}
  \frac{\kvec\cdot\nabla\psi}{\rbpsq} =&
    -\sbt\frac{\Bp}{B\hthe}\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) +
    \sbt\frac{\Bp}{B\hthe}\frac{\Bt R}{B}\deriv{\nu}{x} \\ =&
    -\sbt\frac{\Bp}{B\hthe}\L[\deriv{}{x}\L(\frac{B\hthe}{\Bp}\R) -
    \frac{\Bt R}{B}\deriv{}{x}\L(\frac{\Bt\hthe}{\Bp R}\R)\R] \\ =&
        -\sbt\frac{\Bp}{B\hthe}\L[\hthe\deriv{}{x}\L(\frac{B}{\Bp}\R)
            - \hthe\frac{\Bt R}{B}\deriv{}{x}\L(\frac{\Bt}{\Bp R}\R) +
        \frac{B^2}{B\Bp}\deriv{\hthe}{x} -
    \frac{\Bt^2}{B\Bp}\deriv{\hthe}{x}\R] \\ =& -\sbt
        \frac{\Bp}{B^2\hthe}\deriv{\hthe}{x} -
        \sbt\frac{\Bp}{B^2}\L[B\deriv{}{x}\L(\frac{B}{\Bp}\R) - \Bt
        R\deriv{}{x}\L(\frac{\Bt}{\Bp R}\R)\R]
\end{align*}
%
Writing
%
\begin{align*}
B\deriv{}{x}\L(\frac{B}{\Bp}\R) =&
    \deriv{}{x}\L(\frac{B^2}{\Bp}\R) - \frac{B}{\Bp}\deriv{B}{x} \\ \Bt
    R\deriv{}{x}\L(\frac{\Bt}{\Bp R}\R) =&
    \deriv{}{x}\L(\frac{\Bt^2}{\Bp}\R) - \frac{\Bt}{\Bp
    R}\deriv{}{x}\L(\Bt R\R)
\end{align*}
%
and using $B\deriv{B}{x} = \Bt\deriv{\Bt}{x} + \Bp\deriv{\Bp}{x}$, this
simplifies to give
%
\begin{align}
\frac{\kvec\cdot\nabla\psi}{\rbpsq} =
-\sbt\frac{\Bp^2}{B^2\hthe}\deriv{\hthe}{x} - \sbt\frac{\Bt^2}{B^2
R}\deriv{R}{x}
\label{eq:dhdpsi}
\end{align}
%
This can be transformed into an expression for $\deriv{\hthe}{x}$ involving
only derivatives along field-lines.  Writing $\nabla R =
\deriv{R}{\psi}\nabla\psi + \deriv{R}{\theta}\nabla\theta$,
%
\begin{align*}
\nabla R \cdot \nabla\psi = \deriv{R}{\psi}\rbpsq
\end{align*}
%
Using \ref{eq:flinenablapsi},
%
\begin{align*}
\nabla\psi \cdot \nabla R = -\sbt B R\frac{dZ}{ds}
\end{align*}
%
and so
%
\begin{align*}
\deriv{R}{x} = -\frac{BR}{\rbpsq}\frac{dZ}{ds}
\end{align*}
%
Substituting this and equation \ref{eq:flinekappsi} for $\kvec\cdot\nabla\psi$
into equation~\ref{eq:dhdpsi} the $\deriv{R}{x}$ term cancels with part of the
$\kvec\cdot\nabla\psi$ term, simplifying to
%
\begin{align*}
\deriv{\hthe}{x} =
-\hthe\frac{B^3R}{\Bp^2\rbpsq}\L[\frac{d^2Z}{ds^2}\frac{dR}{ds} -
\frac{d^2R}{ds^2}\frac{dZ}{ds}\R]
\end{align*}
%





\section{Shifted radial derivatives}
%
\label{sec:shiftcoords}
The coordinate system given by equation~\ref{eq:coordtransform} and used in the
above sections has a problem: There is a special poloidal location $\theta_0$
where the radial basis vector $\ve{e}_x$ is purely in the $\nabla\psi$
direction.  Moving away from this location, the coordinate system becomes
sheared in the toroidal direction.

Making the substitution
%
\begin{align*}
\deriv{}{x} = \deriv{}{\psi} + I\deriv{}{z}
\end{align*}
%
we also get the mixed derivative
%
\begin{align*}
\frac{\partial}{\partial z\partial x} =& \deriv{}{z}\deriv{}{\psi} +
    \deriv{I}{z}\deriv{}{z} + I\frac{\partial^2}{\partial z^2} \nonumber \\ =&
    \frac{\partial^2}{\partial z\partial \psi} + I\frac{\partial^2}{\partial
    z^2}
\end{align*}
%
and second-order $x$ derivative
%
\begin{align*}
\frac{\partial^2}{\partial x^2} =& \frac{\partial^2}{\partial \psi^2} +
    \deriv{}{\psi}\L(I\deriv{}{z}\R) + I\deriv{}{z}\L(\deriv{}{\psi}
    + I\deriv{}{z}\R) \nonumber \\ =& \frac{\partial^2}{\partial \psi^2} +
        I^2\frac{\partial^2}{\partial z^2} + 2I\frac{\partial^2}{\partial
        z\partial \psi} + \deriv{I}{\psi}\deriv{}{z}
\end{align*}
%



\subsection{Perpendicular Laplacian}
%
\begin{align*}
\delp = \rbpsq\L[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} +
\L(I^2 + \frac{B^2}{\L(\rbp\R)^4}\R)\dderiv{}{z}\R]
\end{align*}
%
transforms to
%
\begin{align}
\delp = \rbpsq\L[\dderiv{}{\psi} + \deriv{I}{\psi}\deriv{}{z} +
\frac{B^2}{\L(\rbp\R)^4}\dderiv{}{z}\R]
\label{eq:delp}
\end{align}
%
The extra term involving $I$ disappears, but only if {\bf  both} the $x$ and
$z$ first derivatives are taken into account:
%
\begin{align*}
\delp = \rbpsq\L[\dderiv{}{x} - 2I\frac{\partial^2}{\partial z\partial x} +
\L(I^2 + \frac{B^2}{\L(\rbp\R)^4}\R)\dderiv{}{z}\R] +
\nabla^2 x \deriv{}{x} + \nabla^2 z\deriv{}{z}
\end{align*}
%
with
%
\begin{align*}
\nabla^2 x = \frac{1}{J}\deriv{}{x}\L[J\rbpsq\R]
\end{align*}
%
\begin{align}
\nabla^2 z =& \frac{1}{J}\L[-\deriv{}{x}\L(JI\rbpsq\R) -
\deriv{}{y}\L(\frac{\Bt}{\Bp^2R}\R)\R] \nonumber \\ =&
    \frac{1}{J}\L[-I\deriv{}{x}\L(J\rbpsq\R) - \deriv{I}{x}J\rbpsq -
    \deriv{}{y}\L(\frac{\Bt}{\Bp^2R}\R)\R] \label{eq:delpz}
\end{align}
%
where $J=\hthe / \Bp$ is the Jacobian. Transforming into $\psi$ derivatives,
the middle term of equation~\ref{eq:delpz} cancels the $I$ term in
equation~\ref{eq:delp}, but introduces another $I$ term (first term in
equation~\ref{eq:delpz}). This term cancels with the $\nabla^2 x$ term when
$\deriv{}{x}$ is expanded, so the full expression for $\delp$ using $\psi$
derivatives is:
%
\begin{align}
\delp =& \rbpsq\L[\dderiv{}{\psi} +
\frac{B^2}{\L(\rbp\R)^4}\dderiv{}{z}\R] \nonumber \\ &+
    \frac{1}{J}\deriv{}{\psi}\L[J\rbpsq\R]\deriv{}{\psi} -
    \frac{1}{J}\deriv{}{y}\L(\frac{\Bt}{\Bp^2R}\R)\deriv{}{z}
\label{eq:delp_shift}
\end{align}
%


\subsubsection{In orthogonal \texorpdfstring{$\L(\psi, \theta,
\zeta\R)$}{(psi, theta, zeta)} flux coordinates} For comparison, the
perpendicular Laplacian can be derived in orthogonal ``flux'' coordinates
%
\begin{align*}
\L|\nabla\psi\R| = \rbp \qquad \L|\nabla\theta\R| = 1/\hthe
\qquad \L|\nabla\zeta\R| = 1/R
\end{align*}
%
The Laplacian operator is given by
%
\begin{align*}
\nabla^2 A =& \rbpsq\dderiv{A}{\psi} + \frac{1}{\hthe^2}\dderiv{A}{\theta} +
    \frac{1}{R^2}\dderiv{A}{\zeta} \nonumber \\ &+
    \frac{1}{J}\deriv{}{\psi}\L[J\rbpsq\R]\deriv{A}{\psi} +
    \frac{1}{J}\deriv{}{\theta}\L(J/\hthe^2\R)\deriv{A}{\theta}
\end{align*}
%
parallel derivative by
%
\begin{align*}
\partial_{||} \equiv \bvec\cdot\nabla = \frac{\Bp}{B\hthe}\deriv{}{\theta} +
\frac{\Bt}{RB}\deriv{}{\zeta}
\end{align*}
%
and so
%
\begin{align*}
\partial^2_{||}A \equiv \partial_{||}\L(\partial_{||}A\R) =&
    \L(\frac{\Bp}{B\hthe}\R)^2\dderiv{A}{\theta} +
    \L(\frac{\Bt}{RB}\R)^2\dderiv{A}{\zeta} \nonumber \\ &+
    2\frac{\Bp\Bt}{B^2\hthe R}\frac{\partial^2 A}{\partial\theta\partial\zeta}
    \nonumber \\ &+
    \deriv{}{\theta}\L(\frac{\Bp}{B\hthe}\R)\deriv{A}{\theta} +
    \deriv{}{\theta}\L(\frac{\Bt}{RB}\R)\deriv{A}{\zeta}
\end{align*}
%
Hence in orthogonal flux coordinates, the perpendicular Laplacian is:
%
\begin{align}
\delp \equiv \nabla^2 - \partial_{||}^2 = \rbpsq\L[\dderiv{}{\psi} +
\frac{1}{R^4B^2}\dderiv{}{\zeta^2}\R] +
\frac{\Bt^2}{\hthe^2B^2}\dderiv{}{\theta} + \cdots
\label{eq:delp_flux}
\end{align}
%
where the neglected terms are first-order derivatives. The coefficient for the
second-order $z$ derivative differs from equation~\ref{eq:delp_shift}, and
equation~\ref{eq:delp_flux} still contains a derivative in $\theta$. This shows
that the transformation made to get equation~\ref{eq:delp_shift} doesn't result
in the same answer as orthogonal flux coordinates: equation~\ref{eq:delp_shift}
is in field-aligned coordinates.

Note that in the limit of $\Bp = B$, both equations~\ref{eq:delp_shift} and
\ref{eq:delp_flux} are the same, as they should be.



\subsection{Operator \texorpdfstring{$\Bvec\times\nabla\phi\cdot\nabla A$}
%
{B x Nabla Phi Dot Nabla A}}
%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \L(\deriv{\phi}{x}\deriv{A}{y} -
\deriv{\phi}{y}\deriv{A}{x}\R)\L(-\Bt\frac{\rbp}{\hthe}\R) \\ &+
    \L(\deriv{\phi}{x}\deriv{A}{z} -
    \deriv{\phi}{z}\deriv{A}{x}\R)\L(-B^2\R) \\ &-
        \L(\deriv{\phi}{y}\deriv{A}{z} -
        \deriv{\phi}{z}\deriv{A}{y}\R)\L(I\Bt\frac{\rbp}{\hthe}\R)
\end{align*}
%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \L(\deriv{\phi}{\psi}\deriv{A}{y} + I
\deriv{\phi}{z}\deriv{A}{y} - \deriv{\phi}{y}\deriv{A}{\psi} -
I\deriv{\phi}{y}\deriv{A}{z}\R)\L(-\Bt\frac{\rbp}{\hthe}\R) \\ &+
\L(\deriv{\phi}{\psi}\deriv{A}{z} + I\deriv{\phi}{z}\deriv{A}{z} -
\deriv{\phi}{z}\deriv{A}{\psi} -
I\deriv{\phi}{z}\deriv{A}{z}\R)\L(-B^2\R) \\ &-
\L(\deriv{\phi}{y}\deriv{A}{z} -
\deriv{\phi}{z}\deriv{A}{y}\R)\L(I\Bt\frac{\rbp}{\hthe}\R)
\end{align*}
%
\begin{align*}
\Bvec\times\nabla\phi\cdot\nabla A =& \L(\deriv{\phi}{\psi}\deriv{A}{y} -
\deriv{\phi}{y}\deriv{A}{\psi}\R)\L(-\Bt\frac{\rbp}{\hthe}\R)
\nonumber \\ &+ \L(\deriv{\phi}{\psi}\deriv{A}{z} -
\deriv{\phi}{z}\deriv{A}{\psi} \R)\L(-B^2\R)
\end{align*}
%
\bibliography{references} \bibliographystyle{unsrt}

\appendix





\section{Differential geometry}
%
{\color{red} \textbf{WARNING: Several mistakes have been found (and is now
corrected) in this section, so it should be proof read before removing this
warning!}}\\
%
The following is notes from \cite{haeseler-1}.

Sets of vectors $\L\{\mathbf{A, B, C}\R\}$ and $\L\{\mathbf{a, b,
c}\R\}$ are {\bf reciprocal} if
%
\begin{align*}
\mathbf{A\cdot a} = \mathbf{B\cdot b} = \mathbf{C\cdot c} = 1\\ \mathbf{A\cdot
b} = \mathbf{A\cdot c} = \mathbf{B\cdot a} = \mathbf{B\cdot c} = \mathbf{C\cdot
a} = \mathbf{C\cdot b} = 0 \\
\end{align*}
%
which implies that $\L\{\mathbf{A, B, C}\R\}$ and $\L\{\mathbf{a, b,
c}\R\}$ are each linearly independent.  Equivalently,
%
\begin{align*}
\mathbf{a} = \frac{\mathbf{B\times C}}{\mathbf{A\cdot\L(B\times
C\R)}}\qquad \bvec = \frac{\mathbf{C\times A}}{\mathbf{B\cdot\L(C\times
A\R)}}\qquad \mathbf{c} = \frac{\mathbf{A\times
B}}{\mathbf{C\cdot\L(A\times B\R)}}
\end{align*}
%
Either of these sets can be used as a basis, and any vector $\mathbf{w}$ can be
represented as $\mathbf{w} = \L(\mathbf{w\cdot a}\R)\mathbf{A} +
\L(\mathbf{w\cdot b}\R)\Bvec + \L(\mathbf{w\cdot c}\R)\mathbf{C}$
or as $\mathbf{w} = \L(\mathbf{w\cdot A}\R)\mathbf{a} +
\L(\mathbf{w\cdot B}\R)\bvec + \L(\mathbf{w\cdot
C}\R)\mathbf{c}$. In the cartesian coordinate system, the basis vectors are
reciprocal to themselves so this distinction is not needed.  For a general set
of coordinates $\L\{u^1, u^2, u^3\R\}$, {\bf tangent basis vectors} can
be defined. If the cartesian coordinates of a point are given by $\L(x, y,
z\R) = \mathbf{R}\L(u^1, u^2, u^3\R)$ then the tangent basis vectors
are:
%
\begin{align*}
\ve{e}_i = \frac{\partial\mathbf{R}}{\partial u^i}
\end{align*}
%
and in general these will vary from point to point. The {\bf scale factor} or
{\bf metric coefficient} $h_i =\L|\ve{e}_i\R| $ is the distance moved
for a unit change in $u^i$. The unit vector $\hv{e}_i = \ve{e}_i/h_i$.
Definitiion of {\bf nabla operator}:
%
\begin{center}
\framebox{$\nabla\Phi$ of a function $\Phi$ is defined so that $d\Phi =
\nabla\Phi\cdot d{\mathbf{R}}$}
\end{center}
%
From the chain rule, $d\mathbf{R} = \frac{\partial\mathbf{R}}{\partial u^i}du^i
= \ve{e}_idu^i$ and substituting $\Phi = u^i$
%
\begin{align*}
du^i = \nabla u^i\cdot\ve{e}_jdu^j
\end{align*}
%
which can only be true if $\nabla u^i\cdot\ve{e}_j = \delta^i_j$ i.e. if
%
\begin{center}
\framebox{Sets of vectors $\ve{e}^i\equiv\nabla u^i$ and $\ve{e}_j$ are
reciprocal}
\end{center}
%
Since the sets of vectors $\L\{\ve{e}^i\R\}$ and
$\L\{\ve{e}_i\R\}$ are reciprocal, any vector $\mathbf{D}$ can be
written as $\mathbf{D} = D_i\ve{e}^i = D^i\ve{e}_i$ where $D_i = \mathbf{D\cdot
e}_i$ are the {\bf covariant components} and $D^i = \mathbf{D\cdot e}^i$ are
the {\bf contravariant components}. To convert between covariant and
contravariant components, define the {\bf metric coefficients} $g_{ij} =
\mathbf{e_i\cdot e_j}$ and $g^{ij} = \mathbf{e^i\cdot e^j}$ so that $\ve{e}_i =
g_{ij}\ve{e}^j$. $g_{ij}$ and $g^{ij}$ are symmetric and if the basis is
orthogonal then $g_{ij}=g^{ij} = 0$ for $i\neq j$ i.e. the metric is diagonal.
%
\begin{center}
\framebox{$g_{ij} = h_ih_j\hv{e}_i\cdot\hv{e}_j$ and so
$g_{ii} = h_i^2$}
\end{center}
%
For a general set of coordinates, the nabla operator can be expressed as
%
\begin{align*}
\nabla = \nabla u^i\frac{\partial}{\partial u^i} =
\ve{e}^i\frac{\partial}{\partial u^i}
\end{align*}
%
and for a general set of (differentiable) coordinates $\L\{u^i\R\}$, the
Laplacian is given by
%
\begin{align}
\nabla^2\phi = \frac{1}{J}\frac{\partial}{\partial
u^i}\L(Jg^{ij}\frac{\partial\phi}{\partial u^j}\R)
\label{eq:laplacegen}
\end{align}
%
which can be expanded as
%
\begin{align}
\nabla^2\phi = g^{ij}\frac{\partial^2\phi}{\partial u^i\partial u^j} +
\underbrace{\frac{1}{J}\frac{\partial}{\partial
u^i}\L(Jg^{ij}\R)}_{G^j}\frac{\partial\phi}{\partial u^j}
\label{eq:laplace_expand}
\end{align}
%
where $G^j$ must \textbf{not} be mistaken as the so called connection
coefficients (i.e. the Christoffel symbols of second kind).
Setting $\phi = u^k$ in equation (\ref{eq:laplacegen}) gives $\nabla^2u^k =
G^k$. Expanding (\ref{eq:laplacegen}) and setting $\L\{u^i\R\} = \L\{x,
y, z\R\}$ gives
%
\begin{align}
\nabla^2f = \nabla\cdot\nabla f = \nabla\cdot\L(\frac{\partial}{\partial
x}\nabla x + \frac{\partial}{\partial y}\nabla y + \frac{\partial}{\partial
z}\nabla z\R) \nonumber \\
\label{eq:general_laplacian}
= \frac{\partial^2 f}{\partial x^2}\L|\nabla x\R|^2 + \frac{\partial^2
f}{\partial y^2}\L|\nabla y\R|^2 + \frac{\partial^2 f}{\partial
z^2}\L|\nabla z\R|^2 \\ +2\frac{\partial^2 f}{\partial x\partial
y}\L(\nabla x\cdot\nabla y\R) +2\frac{\partial^2 f}{\partial x\partial
z}\L(\nabla x\cdot\nabla z\R) +2\frac{\partial^2 f}{\partial y\partial
z}\L(\nabla y\cdot\nabla z\R) \nonumber \\ +\nabla^2x\frac{\partial
f}{\partial x} +\nabla^2y\frac{\partial f}{\partial y} +
\nabla^2z\frac{\partial f}{\partial z} \nonumber
\end{align}
%
Curl defined as:
%
\begin{align*}
\nabla\times\mathbf{A} = \frac{1}{\sqrt{g}}\sum_k\L(\frac{\partial
A_j}{\partial u_i} - \frac{\partial A_i}{\partial u_j}\R)\ve{e}_k \qquad
i,j,k \texttt{ cyc } 1,2,3
\end{align*}
%
Cross-product relation between contravariant and covariant vectors:
%
\begin{align*}
\ve{e}^i = \frac{1}{J}\L(\ve{e}_j \times \ve{e}_k\R) \qquad \ve{e}_i =
J\L(\ve{e}^j \times \ve{e}^k\R) \qquad i,j,k \texttt{ cyc } 1,2,3
\end{align*}
%



\section{Derivation of operators in the BOUT++ Clebsch system}
%
The Clebsch system in BOUT++ goes like this
%
\begin{align*}
    \ve{B}=&\nabla z \times \nabla x\\
    =&\ve{e}^z \times \ve{e}^x\\
    J^{-1}\ve{e}_y=&\ve{e}^z \times \ve{e}^x
\end{align*}
%
We have
%
\begin{align*}
    B\defined & \sqrt{\ve{B}\cdot\ve{B}}
    = \sqrt{J^{-1}\ve{e}_y\cdot J^{-1}\ve{e}_y}
    = \sqrt{J^{-2}g_{yy}}
    = J^{-1}\sqrt{g_{yy}}
\end{align*}
%
Further on
%
\begin{align*}
    \ve{B}=&B\ve{b}\\
    \ve{b}=&\frac{\ve{B}}{B}
          =\frac{J^{-1}\ve{e}_y}{J^{-1}\sqrt{g_{yy}}}
          =\frac{\ve{e}_y}{\sqrt{g_{yy}}}
\end{align*}
%



\subsection{The parallel and perpendicular gradients}
%
We have that
%
\begin{align*}
    \Grad =& \ve{e}^i \partial_i
          = \ve{e}^x \partial_x + \ve{e}^y \partial_y + \ve{e}^z \partial_z
\end{align*}
%
and that
%
\begin{align*}
    \Grad_\| =& \L(\ve{b} \cdot \Grad\R) \ve{b}
             = \ve{b} \ve{b} \cdot \Grad
             = \frac{\ve{e}_y \ve{e}_y}{g_{yy}} \cdot \Grad
             = \frac{\ve{e}_y \ve{e}_y}{g_{yy}} \cdot \ve{e}^i \partial_i
             = \frac{\ve{e}_y}{g_{yy}} \partial_y
\end{align*}
%
so that
%
\begin{align*}
    \Grad_\perp =& \Grad - \Grad_\|\\
%
                =& \ve{e}^x \partial_x + \ve{e}^y \partial_y + \ve{e}^z
                   \partial_z - \frac{\ve{e}_y}{g_{yy}} \partial_y\\
%
                =& \ve{e}^x \partial_x + \ve{e}^y \partial_y + \ve{e}^z
                   \partial_z - \frac{g_{2i}\ve{e}^i}{g_{22}} \partial_y\\
%
                =& \ve{e}^x \partial_x + \ve{e}^y \partial_y + \ve{e}^z
                   \partial_z
                   - \frac{g_{21}\ve{e}^x
                          +g_{22}\ve{e}^y
                          +g_{23}\ve{e}^z
                          }{g_{22}}\partial_y\\
%
                =& \ve{e}^x \L(\partial_x - \frac{g_{21}}{g_{22}}\partial_y\R)
                +  \ve{e}^z \L(\partial_z - \frac{g_{23}}{g_{22}}\partial_y\R)
\end{align*}
%
\subsubsection{The perpendicular gradients in Laplacian inversion}
In the Laplacian inversion BOUT++ currently neglects the parallel derivatives,
thus
%
\begin{align*}
    \Grad_\perp \simeq&
        \ve{e}^x \partial_x
     +  \ve{e}^z \partial_z
\end{align*}




\subsection{The Laplacian}
%
We would here like to find an expression for the Laplacian
%
\begin{align*}
    \Grad^2 = \Div \Grad
\end{align*}
%
In general we have (using equation (2.6.39) in D'Haeseleer \cite{haeseler-1})
%
\begin{align}
    \Div \ve{A} = \frac{1}{J} \partial_i \L(JA^i\R)
    \label{eq:divA}
\end{align}
%
and that
%
\begin{align*}
    A^i = \ve{A}\cdot \ve{e}^i
\end{align*}
%
In our case $A \to \Grad$, so that
%
\begin{align*}
    \Grad^i = \L(\Grad\R)\cdot \ve{e}^i
             = \ve{e}^i \cdot \L(\Grad\R)
             = \ve{e}^i \cdot \L(\ve{e}^j \partial_j\R)
             = g^{ij} \partial_j
\end{align*}
%
Thus
%
\begin{align*}
    \Grad^2 =& \frac{1}{J} \partial_i \L(J g^{ij} \partial_j\R)\\
            =& \frac{1}{J} g^{ij} J \partial_i \partial_j
             + \frac{1}{J} \partial_i \L(J g^{ij} \R) \partial_j\\
            =& g^{ij} \partial_i \partial_j
             + G^j \partial_j\\
\end{align*}
%
where we have defined%
%
\footnote{%
Notice that $G^i$ is \textbf{not} the same as the \emph{Christoffel symbols of
second kind} (also known as the \emph{connection coefficients} or
$\Gamma^i_{jk}=\ve{e}^i\cdot\partial_k \ve{e}_j$), although the derivation of
the two are quite similar.\\
We find that $\Gamma^i_{ji}=\ve{e}^i\cdot\partial_i \ve{e}_j = \Div \ve{e}_j$,
whereas using equation \ref{eq:divA} leads to
$G^i=\ve{e}^i\cdot\partial_i \ve{e}^j = \Div \ve{e}^j$, since $g^{ji}=g^{ij}$
due to
symmetry.
}%
%
\begin{align*}
    G^j =& \frac{1}{J} \partial_i \L(J g^{ij} \R)\\
        =& \frac{1}{J} \L(
           \partial_x \L[J g^{xj} \R]
         + \partial_y \L[J g^{yj} \R]
         + \partial_z \L[J g^{zj} \R]
         \R)
\end{align*}
%
By writing the terms out, we get
%
\begin{align*}
    \Grad^2 =& g^{ij} \partial_i \partial_j + G^j \partial_j\\
%
            =& \L(  g^{xj} \partial_x \partial_j
                  + g^{yj} \partial_y \partial_j
                  + g^{zj} \partial_z \partial_j\R)
               + \L(G^j \partial_j\R)\\
%
            =& \quad \,
               \L(  g^{xx} \partial_x^2
                  + g^{yx} \partial_y \partial_x
                  + g^{zx} \partial_z \partial_x\R)
               + \L(G^x \partial_x\R)\\
            &+ \L(  g^{xy} \partial_x \partial_y
                  + g^{yy} \partial_y^2
                  + g^{zy} \partial_z \partial_y\R)
               + \L(G^y \partial_y\R)\\
            &+ \L(  g^{xz} \partial_x \partial_z
                  + g^{yz} \partial_y \partial_z
                  + g^{zz} \partial_z^y\R)
               + \L(G^z \partial_z\R)
\end{align*}
%
We now use that the metric tensor is symmetric (by definition), so that
$g^{ij}=g^{ji}$, and $g_{ij}=g_{ji}$, and that the partial derivatives
commutes for smooth functions $\partial_i\partial_j=\partial_j\partial_i$.
This gives
%
\begin{align*}
    \Grad^2 =&\quad \,
               \L(g^{xx} \partial_x^2 \R)
               + \L(G^x \partial_x\R)\\
            &+ \L(g^{yy} \partial_y^2 \R)
               + \L(G^y \partial_y\R)\\
            &+ \L(g^{zz} \partial_z^2\R)
               + \L(G^z \partial_z\R)\\
            &+ 2\L( g^{xy} \partial_x \partial_y
                  + g^{xz} \partial_x \partial_z
                  + g^{yz} \partial_y \partial_z
                  \R)\\
%
	   =&\quad \,
               \L(g^{xx} \partial_x^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xx} \R\}
                    + \partial_y \L\{J g^{yx} \R\}
                    + \partial_z \L\{J g^{zx} \R\}
                    \R]
                    \partial_x\R)\\
            &+ \L(g^{yy} \partial_y^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xy} \R\}
                    + \partial_y \L\{J g^{yy} \R\}
                    + \partial_z \L\{J g^{zy} \R\}
                    \R]
                    \partial_y\R)\\
            &+ \L(g^{zz} \partial_z^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xz} \R\}
                    + \partial_y \L\{J g^{yz} \R\}
                    + \partial_z \L\{J g^{zz} \R\}
                    \R]
                    \partial_z\R)\\
            &+ 2\L( g^{xy} \partial_x \partial_y
                  + g^{xz} \partial_x \partial_z
                  + g^{yz} \partial_y \partial_z
                  \R)
\end{align*}
%
Notice that $G^i$ does not operate on $\partial_i$, but rather that the two are
multiplied together.
%



\subsection{The parallel Laplacian}
%
We have that
%
\begin{align*}
    \Grad_\| =& \L(\ve{b} \cdot \Grad\R) \ve{b}\
             = \ve{b} \ve{b} \cdot \Grad
             = \frac{\ve{e}_y \ve{e}_y}{g_{yy}} \cdot \Grad
             = \frac{\ve{e}_y \ve{e}_y}{g_{yy}} \cdot \ve{e}^i \partial_i
             = \frac{\ve{e}_y}{g_{yy}} \partial_y
\end{align*}
%
we have that
%
\begin{align*}
    \Grad_\|^i =& \L(\frac{\ve{e}_y}{g_{yy}} \partial_y\R)\cdot \ve{e}^i
               = \ve{e}^i \cdot \L(\frac{\ve{e}_y}{g_{yy}} \partial_y\R)
\end{align*}
%
so that by equation (\ref{eq:divA}),
%
\begin{align*}
    \Grad_\|^2 =& \Div\L(\ve{b} \ve{b} \cdot \Grad\R)\\
               =& \Div\L(\frac{\ve{e}_y}{g_{yy}} \cdot \partial_y\R)\\
               =& \frac{1}{J} \partial_i \L(
		      J\ve{e}^i \cdot \L[\frac{\ve{e}_y}{g_{yy}} \partial_y\R]
		  \R)\\
               =& \frac{1}{J} \partial_y \L(\frac{J}{g_{yy}} \partial_y\R)
\end{align*}
%



\subsection{The perpendicular Laplacian}
For the perpendicular Laplacian, we have that
%
\begin{align*}
    \Grad_\perp^2 =& \Grad^2 - \Grad_\|^2\\
                  =& g^{ij} \partial_i \partial_j + G^j \partial_j
                    -\frac{1}{J} \partial_y \L(\frac{J}{g_{yy}} \partial_y\R)\\
%
            =& \quad \,
               \L(g^{xx} \partial_x^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xx} \R\}
                    + \partial_y \L\{J g^{yx} \R\}
                    + \partial_z \L\{J g^{zx} \R\}
                    \R]
                    \partial_x\R)\\
            &+ \L(g^{yy} \partial_y^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xy} \R\}
                    + \partial_y \L\{J g^{yy} \R\}
                    + \partial_z \L\{J g^{zy} \R\}
                    \R]
                    \partial_y\R)\\
            &+ \L(g^{zz} \partial_z^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xz} \R\}
                    + \partial_y \L\{J g^{yz} \R\}
                    + \partial_z \L\{J g^{zz} \R\}
                    \R]
                    \partial_z\R)\\
            &+ 2\L( g^{xy} \partial_x \partial_y
                  + g^{xz} \partial_x \partial_z
                  + g^{yz} \partial_y \partial_z
                  \R)\\
            &- \frac{1}{J} \partial_y \L(\frac{J}{g_{yy}} \partial_y\R)
\end{align*}
%



\subsubsection{The perpendicular Laplacian in Laplacian inversion}
%
Notice that BOUT++ currently assumes small parallel gradients in the dependent
variable in Laplacian inversion, so that
%
\begin{align*}
    \Grad_\perp^2 \simeq& \quad \,
               \L(g^{xx} \partial_x^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xx} \R\}
                    + \partial_y \L\{J g^{yx} \R\}
                    + \partial_z \L\{J g^{zx} \R\}
                    \R]
                    \partial_x\R)\\
            &+ \L(g^{zz} \partial_z^2\R)
               + \L(
                    \frac{1}{J} \L[
                      \partial_x \L\{J g^{xz} \R\}
                    + \partial_y \L\{J g^{yz} \R\}
                    + \partial_z \L\{J g^{zz} \R\}
                    \R]
                    \partial_z\R)\\
            &+ 2\L(g^{xz} \partial_x \partial_z\R)\\
%
%
           =&
               \L(g^{xx} \partial_x^2\R)
               +
                    G^x\partial_x
            + \L(g^{zz} \partial_z^2\R)
               + G^z \partial_z
            + 2\L(g^{xz} \partial_x \partial_z\R)
\end{align*}
%



\subsection{The Laplacian inversion}
%
We will here go through the calulations of the laplacian inversion algorithm,
as it is performed in BOUT++. We would like to solve the following equation
for $f$
%
\begin{align}
    d&\Grad_\perp^2f + \frac{1}{c_1}(\Grad_\perp c_2)\cdot\Grad_\perp f + af = b
    \label{eq:to_invert}
\end{align}
%
In all currently implemented solvers, the paralle derivatives are neglected.
Thus, equation (\ref{eq:to_invert}) becomes
%
\begin{align*}
    \, &d
    \L(    g^{xx} \partial_x^2
         + G^x \partial_x
         + g^{zz} \partial_z^2
         + G^z \partial_z
         + 2g^{xz} \partial_x \partial_z
    \R)
    f
    \\
%
    +& \frac{1}{c_1}\L(
          \ve{e}^x \partial_x
       +  \ve{e}^z \partial_z
    \R)
    c_2
    \cdot
       \L(
          \ve{e}^x \partial_x
       +  \ve{e}^z \partial_z
       \R)
       f
       \\
%
    +& af = b
    \numberthis
    \label{eq:invert_expanded}
\end{align*}
%


\subsubsection{Using tridiagonal solvers}
%
When using the tridiagonal solvers, $c_1 = c_2$ in equation
(\ref{eq:to_invert_tri}), hence, it is rather solving
%
%
\begin{align}
    d&\Grad_\perp^2f + \frac{1}{c}(\Grad_\perp c)\cdot\Grad_\perp f + af = b
    \label{eq:to_invert_tri}
\end{align}
%
%
In order to use a tridiagonal solver to solve equation
(\ref{eq:to_invert_tri}), we will first assume that the parallel derivatives
are small. This means that we will only have derivatives of $x$ and $z$ for the
dependent variable. The hope is that the modes in the periodic $z$ direction
will decouple, so that we in the end only have to invert for the $x$
coordinate.

If the modes decouples when fourier transforming equation
(\ref{eq:invert_expanded}), we can use a tridiagonal solver to solve the
equation for each fourier mode.

Using the discrete fourier transform
%
\begin{align}
    F(x,y)_{k} =
    \frac{1}{N}\sum_{Z=0}^{N-1}f(x,y)_{Z}\exp\L(\frac{-2\pi i k Z}{N}\R)
\end{align}
%
we see that the modes will not decouple if a term consist of a product of two
terms which depends on $z$, as this would give terms like
%
\begin{align*}
    \frac{1}{N}\sum_{Z=0}^{N-1}
        a(x,y)_Z
        f(x,y)_Z
        \exp\L(\frac{-2\pi i k Z}{N}\R)
\end{align*}
%
Thus, in order to use a tridiagonal solver, $a$, $c$ and $d$ cannot be
functions of $z$. Because of this, the $\ve{e}^z \partial_z c$ term in equation
(\ref{eq:invert_expanded}) is zero. In principle the modes would still decouple
if the $\ve{e}^z \partial_z f$ part of equation (\ref{eq:invert_expanded}) was
kept, but currently this part is also neglected in solvers using a tridiagonal
matrix. Thus the tridiagonal solvers are solving equations on the form
%
\begin{align*}
    \, &d(x,y)
    \L(    g^{xx}(x,y) \partial_x^2
         + G^x(x,y) \partial_x
         + g^{zz}(x,y) \partial_z^2
         + G^z(x,y) \partial_z
         + 2g^{xz}(x,y) \partial_x \partial_z
    \R)
    f(x,y,z)
    \\
%
    +& \frac{1}{c(x,y)}\L(
          \ve{e}^x \partial_x
    \R)
    c(x,y)
    \cdot
       \L(
          \ve{e}^x \partial_x
       \R)
       f(x,y,z)
       \\
%
   +& a(x,y)f(x,y,z) = b(x,y,z)
\end{align*}
%
after using the discrete fourier transform (see section \ref{sec:deriv_of_FT}),
we get
%
\begin{align*}
    \, &d
    \L(    g^{xx} \partial_x^2F_z
         + G^x \partial_xF_z
         + g^{zz} [i k]^2F_z
         + G^z [i k]F_z
         + 2g^{xz} \partial_x[i k]F_z
    \R)
    \\
%
    +& \frac{1}{c}\L(
          \ve{e}^x \partial_x
    \R)
    c
    \cdot
       \L(
          \ve{e}^x \partial_xF_z
       \R)
       \\
%
    +& aF_z = B_z
\end{align*}
%
which gives
%
\begin{align*}
    \, &d
    \L(    g^{xx} \partial_x^2
         + G^x \partial_x
         - k^2 g^{zz}
         + i kG^z
         + i k2g^{xz} \partial_x
    \R)F_z
    \\
%
    +& \frac{g^{xx}}{c}
    \L(
        \partial_x c
    \R)
     \partial_xF_z
       \\
%
    +& aF_z = B_z
    \numberthis
    \label{eq:FT_laplace_inversion}
\end{align*}
%
As nothing in equation (\ref{eq:FT_laplace_inversion}) couples points in $y$
togehter (since we have neglected the $y$-derivatives). Also, as the modes are
decoupled, we may solve equation (\ref{eq:FT_laplace_inversion})  $k$ mode by
$k$ mode in addition to $y$-point by $y$-point.

The second order centered approximation of the first and second derivatives in
$x$ reads
%
\begin{align*}
    &&\partial_x f \simeq \frac{-f_{n-1} + f_{n+1}}{2\text{d}x}&&
    &&\partial_x^2 f \simeq \frac{f_{n-1} - f_{n} + f_{n+1}}{\text{d}x^2}&&
\end{align*}
%
This gives
%
\begin{align*}
    \, &d
    \L(    g^{xx} \frac{F_{z,n-1} - 2F_{z,n} + F_{z, n+1}}{\text{d}x^2}
         + G^x \frac{-F_{z,n-1} + F_{z,n+1}}{2\text{d}x}
         - k^2 g^{zz}F_{z,n}
         \R.\\
         &\quad\L.
         + i kG^zF_{z,n}
         + i k2g^{xz} \frac{-F_{z,n-1} + F_{z,n+1}}{2\text{d}x}
    \R)
    \\
%
    +& \frac{g^{xx}}{c}
    \L(
        \frac{-c_{n-1} + c_{n+1}}{2\text{d}x}
    \R)
     \frac{-F_{z,n-1} + F_{z,n+1}}{2\text{d}x}
       \\
%
    +& aF_{z,n} = B_{z,n}
\end{align*}
%
collecting point by point
%
\begin{align*}
    &\L(
          \frac{dg^{xx}}{\text{d}x^2}
        - \frac{dG^x}{2\text{d}x}
        - \frac{g^{xx}}{c_{n}}
          \frac{-c_{n-1} + c_{n+1}}{4\text{d}x^2}
        - i\frac{d k2g^{xz}}{2\text{d}x}
    \R)
    F_{z,n-1}
    \\
    %
    &\L(
       - \frac{ dg^{xx} }{\text{d}x^2}
       - dk^2 g^{zz}
       + a
       + idkG^z
    \R)
    F_{z,n}
    \\
    %
    &\L(
          \frac{dg^{xx}}{\text{d}x^2}
        + \frac{dG^x}{2\text{d}x}
        + \frac{g^{xx}}{c_{n}}
          \frac{-c_{n-1} + c_{n+1}}{4\text{d}x^2}
        + i\frac{dk2g^{xz}}{2\text{d}x}
    \R)
    F_{z, n+1}
    \\
%
     =& B_{z,n}
    \numberthis
    \label{eq:discretized_laplace}
\end{align*}
%
We now introduce
%
\begin{align*}
    &c_1 = \frac{dg^{xx}}{\text{d}x^2}&
    &c_2 = dg^{zz}&
    &c_3 = \frac{2dg^{xz}}{2\text{d}x}& &&
    \\
    &c_4 = \frac{dG^x + g^{xx}\frac{-c_{n-1} + c_{n+1}}{2c_n\text{d}x}}{2\text{d}x}&
    &c_5 = dG^z&
    &&
\end{align*}
%
which inserted in equation (\ref{eq:discretized_laplace}) gives
%
\begin{align*}
    &\L(
        c_1 - c_4
        -ikc_3
    \R)
    F_{z,n-1}
    \\
    %
    &\L(
       -2c_1 - k^2c_2
       +ikc_5
       + a
    \R)
    F_{z,n}
    \\
    %
    &\L(
        c_1 + c_4
        + ikc_3
    \R)
    F_{z, n+1}
    \\
%
     =& B_{z,n}
\end{align*}
%
This can be formulated as the matrix equation
%
\begin{align*}
    AF_z=B_z
\end{align*}
%
where the matrix $A$ is tridiagonal. The boundary conditions are set by
setting the first and last rows in $A$ and $B_z$.
%


\subsubsection{Using PETSc solvers}
%
When using PETSc, all terms of equation (\ref{eq:invert_expanded}) is being
used when inverting to find $f$. Note that when using PETSc, we are not fourier
decomposing in the $z$-direction, so it may take substantially longer time to
find the solution.  As with the tridiagonal solver, the fields are being sliced
in the $y$-direction, and a solution is being found for one $y$ plane at the
time.

Before solving, equation (\ref{eq:invert_expanded}) is rewritten to the form
$A\ve{x} =\ve{b}$ (however, the full $A$ is not expanded in memory). To do
this, a row $i$ in the matrix $A$ is indexed from bottom left of the two
dimensional field $= (0,0) = 0$ to top right $= (\texttt{meshx}-1,
\texttt{meshz}-1) = \texttt{meshx}\cdot\texttt{meshz}-1$ of the two dimensional
field. This is done in such a way so that a row $i$ in $A$ increments by $1$
for an increase of $1$ in the $z-$direction, and by $\texttt{meshz}$ for an
increase of $1$ in the $x-$direction, where the variables $\texttt{meshx}$ and
$\texttt{meshz}$ represents the highest value of the field in the given
direction.

Similarly to equation (\ref{eq:discretized_laplace}), the discretized version
of equation (\ref{eq:invert_expanded}) can be written. Doing the same for the
full two dimensional case yields\\
%
\begin{minipage}{0.45\textwidth}
Second order approximation
%
\begin{align*}
    \;
    &
    c_{i,j}
    f_{i,j}
    \\
    %
    &+
    c_{i-1,j-1}
    f_{i-1,j-1}
    +
    c_{i-1,j}
    f_{i-1,j}
    \\
    %
    &+
    c_{i-1,j+1}
    f_{i-1,j+1}
    +
    c_{i,j-1}
    f_{i,j-1}
    \\
    %
    &+
    c_{i,j+1}
    f_{i,j+1}
    +
    c_{i+1,j-1}
    f_{i+1,j-1}
    \\
    %
    &+
    c_{i+1,j}
    f_{i+1,j}
    +
    c_{i+1,j+1}
    f_{i+1,j+1}
    \\
%
    =& b_{i,j}
\end{align*}
\end{minipage}
%
\hspace{1cm}
%
\begin{minipage}{0.45\textwidth}
Fourth order approximation
%
\begin{align*}
    \;
    &
    c_{i,j}
    f_{i,j}
    \\
    %
    &+
    c_{i-2,j-2}
    f_{i-2,j-2}
    +
    c_{i-2,j-1}
    f_{i-2,j-1}
    \\
    %
    &+
    c_{i-2,j}
    f_{i-2,j}
    +
    c_{i-2,j+1}
    f_{i-2,j+1}
    \\
    %
    &+
    c_{i-2,j+2}
    f_{i-2,j+2}
    +
    c_{i-1,j-2}
    f_{i-1,j-2}
    \\
    %
    &+
    c_{i-1,j-1}
    f_{i-1,j-1}
    +
    c_{i-1,j}
    f_{i-1,j}
    \\
    %
    &+
    c_{i-1,j-1}
    f_{i-1,j-1}
    +
    c_{i-1,j}
    f_{i-1,j}
    \\
    %
    &+
    c_{i-1,j+1}
    f_{i-1,j+1}
    +
    c_{i-1,j+2}
    f_{i-1,j+2}
    \\
    %
    &+
    c_{i,j-2}
    f_{i,j-2}
    +
    c_{i,j-1}
    f_{i,j-1}
    \\
    %
    &+
    c_{i,j+1}
    f_{i,j+1}
    +
    c_{i,j+2}
    f_{i,j+2}
    \\
    %
    &+
    c_{i+1,j-2}
    f_{i+1,j-2}
    +
    c_{i+1,j-1}
    f_{i+1,j-1}
    \\
    %
    &+
    c_{i+1,j}
    f_{i+1,j}
    +
    c_{i+1,j+1}
    f_{i+1,j+1}
    \\
    %
    &+
    c_{i+1,j+2}
    f_{i+1,j+2}
    +
    c_{i+2,j-2}
    f_{i+2,j-2}
    \\
    %
    &+
    c_{i+2,j-1}
    f_{i+2,j-1}
    +
    c_{i+2,j}
    f_{i+2,j}
    \\
    %
    &+
    c_{i+2,j+1}
    f_{i+2,j+1}
    +
    c_{i+2,j+2}
    f_{i+2,j+2}
    \\
%
    =& b_{i,j}
\end{align*}
\end{minipage}
\\
To determine the coefficient for each node point, it is convenient to introduce
some quantities
%
\begin{align*}
    &A_0 = a(x,y_{\text{current}},z)&
    &A_1 = dg^{xx}&\\
    &A_2 = dg^{zz}&
    &A_3 = 2dg^{xz}&
\end{align*}
%
In addition, we have\\
%
\begin{minipage}{0.45\textwidth}
Second order approximation
\begin{align*}
    \texttt{ddx\_c} =
     \frac{\texttt{c2}_{x+1} - \texttt{c2}_{x-1}
      }{
      2\texttt{c1}\text{d}x}\\
    %
    \texttt{ddz\_c} =
     \frac{\texttt{c2}_{z+1} - \texttt{c2}_{z-1}
      }{
      2\texttt{c1}\text{d}z}
\end{align*}
\end{minipage}
%
\hspace{1cm}
%
\begin{minipage}{0.45\textwidth}
Fourth order approximation
\begin{align*}
    \texttt{ddx\_c} =
     \frac{-\texttt{c2}_{x+2} + 8\texttt{c2}_{x+1} - 8\texttt{c2}_{x-1} + \texttt{c2}_{x-1}
      }{
      12\texttt{c1}\text{d}x}\\
    %
    \texttt{ddz\_c} =
     \frac{-\texttt{c2}_{z+2} + 8\texttt{c2}_{z+1} - 8\texttt{c2}_{z-1} + \texttt{c2}_{z-1}
      }{
      12\texttt{c1}\text{d}z}
\end{align*}
\end{minipage}
\\
%
This gives
%
\begin{align*}
    &A_4 = dG^x + g^{xx}\texttt{ddx\_c} + g^{xz}\texttt{ddz\_c}&
    &A_5 = dG^z + g^{xz}\texttt{ddx\_c} + g^{xx}\texttt{ddz\_c}&
\end{align*}
%
The coefficients $c_{i+m,j+n}$ are finally being set according to the
appropriate order of discretization. The coefficients can be found in
the file \texttt{petsc\_laplace.cxx}.




\subsection{The Poisson bracket operator}
%
We will here derive the bracket operators, as they are used in BOUT++.

\subsubsection{The electrostatic \texorpdfstring{$\ve{E}\times \ve{B}$}{ExB}
	       velocity}
%
Under electrostatic conditions, we have that $\ve{v}_E =
-\frac{\nabla\phi\times\ve{b}}{B}$, which is similar to
$\ve{v}=\ve{k}\times\nabla\psi$ found in incompressible fluid flow
%
\begin{align*}
    \ve{v}_E =& -\frac{\nabla\phi\times\ve{b}}{B}\\
	     %
	     =&-\frac{\nabla\phi\times\ve{e}_y}{
               \sqrt{g_{yy}}J^{-1}\sqrt{g_{yy}}}\\
             %
	     =&-\frac{J}{g_{yy}}\nabla\phi\times\ve{e}_y\\
	     %
	     =&\frac{J}{g_{yy}}\ve{e}_y\times\nabla\phi\\
	     %
	     =&\frac{J}{g_{yy}}\ve{e}_y\times
	       \L(\ve{e}^x\partial_x + \ve{e}^z\partial_z\R)\phi\\
	     %
	     =&\frac{J}{g_{yy}}
	       \L(g_{yx}\ve{e}^x + g_{yy}\ve{e}^y + g_{yz}\ve{e}^z\R)
	       \times
	       \L(\ve{e}^x\partial_x +
	          \ve{e}^y\partial_y +
                  \ve{e}^z\partial_z\R)\phi\\
             %
	     =&\frac{J}{g_{yy}}
	       \L(
	         g_{yx}\ve{e}^x\times\ve{e}^x\partial_x
	       + g_{yy}\ve{e}^y\times\ve{e}^x\partial_x
	       + g_{yz}\ve{e}^z\times\ve{e}^x\partial_x
	       \R.
	       \\
	       &\quad\;
	       + g_{yx}\ve{e}^x\times\ve{e}^y\partial_y
	       + g_{yy}\ve{e}^y\times\ve{e}^y\partial_y
	       + g_{yz}\ve{e}^z\times\ve{e}^y\partial_y
	       \\
	       &\quad\;
	       \L.
	       + g_{yx}\ve{e}^x\times\ve{e}^z\partial_z
	       + g_{yy}\ve{e}^y\times\ve{e}^z\partial_z
	       + g_{yz}\ve{e}^z\times\ve{e}^z\partial_z
	       \R)
	       \phi\\
	     %
	     =&\frac{J}{g_{yy}}
	       \L(
	       - g_{yy}\ve{e}^y\times\ve{e}^x\partial_x
	       + g_{yz}\ve{e}^z\times\ve{e}^x\partial_x
	       \R.
	       \\
	       &\quad
	       + g_{yx}\ve{e}^x\times\ve{e}^y\partial_y
	       - g_{yz}\ve{e}^z\times\ve{e}^y\partial_y
	       \\
	       &\quad
	       \L.
	       - g_{yx}\ve{e}^x\times\ve{e}^z\partial_z
	       + g_{yy}\ve{e}^y\times\ve{e}^z\partial_z
	       \R)
	       \phi\\
	     %
	     =&\frac{1}{g_{yy}}
	       \L(
	       - g_{yy}\ve{e}_z\partial_x
	       + g_{yz}\ve{e}_y\partial_x
	       + g_{yx}\ve{e}_z\partial_y
	       - g_{yz}\ve{e}_x\partial_y
	       - g_{yx}\ve{e}_y\partial_z
	       + g_{yy}\ve{e}_x\partial_z
	       \R)
	       \phi
\end{align*}


\subsubsection{The electrostatic \texorpdfstring{$\ve{E}\times \ve{B}$}{ExB}
	       advection}
%
The electrostatic $E\times B$ advection operator thus becomes
%
\begin{align*}
    \ve{v}_E\cdot\nabla
    =& -\frac{\nabla\phi\times\ve{b}}{B}\cdot\nabla\\
    %
    %
    =&\frac{1}{g_{yy}}
	       \L(
	       - g_{yy}\ve{e}_z\partial_x
	       + g_{yz}\ve{e}_y\partial_x
	       + g_{yx}\ve{e}_z\partial_y
	       - g_{yz}\ve{e}_x\partial_y
	       - g_{yx}\ve{e}_y\partial_z
	       + g_{yy}\ve{e}_x\partial_z
	       \R)
	       \phi
       \cdot\L(\ve{e}^x\partial_x + \ve{e}^y\partial_y + \ve{e}^z\partial_z\R)\\
    %
    %
    =& \frac{1}{g_{yy}}
	       \L(
	       - g_{yy}\partial_x\phi\partial_z
	       + g_{yz}\partial_x\phi\partial_y
	       + g_{yx}\partial_y\phi\partial_z
	       - g_{yz}\partial_y\phi\partial_x
	       - g_{yx}\partial_z\phi\partial_y
	       + g_{yy}\partial_z\phi\partial_x
	       \R)\\
    %
    %
    =& \frac{1}{g_{yy}}
	       \L(
	         \L[
	           g_{yy}\partial_z\phi
	         - g_{yz}\partial_y\phi
	         \R]\partial_x
	       +
	         \L[
	           g_{yz}\partial_x\phi
	         - g_{yx}\partial_z\phi
	         \R]\partial_y
	       +
	         \L[
	           g_{yx}\partial_y\phi
	         - g_{yy}\partial_x\phi
	         \R]\partial_z
	       \R)\\
    %
    %
    =& \frac{1}{g_{yy}}
               \L(
                 g_{yx}\{\phi, \cdot\}_{y,z}
                 +
                 g_{yy}\{\phi, \cdot\}_{z,x}
                 +
                 g_{yz}\{\phi, \cdot\}_{x,y}
               \R)
\end{align*}
%
Where we have used the definition of the Poisson bracket
%
\begin{align*}
    \{a, b\}_{i,j} =
      \L(\partial_i a\R) \partial_j b
    - \L(\partial_j a\R) \partial_i b
\end{align*}
%
The pure solenoidal advection is thus
%
\begin{align*}
    B\ve{v}_E\cdot\nabla
    =& -\nabla\phi\times\ve{b}\cdot\nabla\\
    %
    %
    =& \ve{b} \times \nabla\phi\cdot\nabla\\
    %
    %
    =& \frac{\sqrt{g_{yy}}}{Jg_{yy}}
               \L(
                 g_{yx}\{\phi, \cdot\}_{y,z}
                 +
                 g_{yy}\{\phi, \cdot\}_{z,x}
                 +
                 g_{yz}\{\phi, \cdot\}_{x,y}
               \R)
               \\
    %
    %
    =& \frac{1}{J\sqrt{g_{yy}}}
               \L(
                 g_{yx}\{\phi, \cdot\}_{y,z}
                 +
                 g_{yy}\{\phi, \cdot\}_{z,x}
                 +
                 g_{yz}\{\phi, \cdot\}_{x,y}
               \R)
	       \numberthis
	       \label{eq:brackets}
\end{align*}


\subsubsection{The brackets operator in BOUT++}
%
Notice that the \verb@brackets(phi,f)@ operators in BOUT++ returns
$-\frac{\nabla\phi\times\ve{b}}{B}\cdot\nabla f$ rather than
$-\nabla\phi\times\ve{b}\cdot\nabla f$.

Notice also that the Arakawa brackets neglects the $\partial_y$ derivative
terms (the $y$-derivative terms), so for the Arakawa brackets BOUT++ returns
%
\begin{align*}
    \ve{v}_E\cdot\nabla
    =& -\frac{\nabla\phi\times\ve{b}}{B}\cdot\nabla\\
    %
    \simeq& \frac{1}{g_{yy}}
	       \L(
                 g_{yy}\{\phi, \cdot\}_{z,x}
	       \R)\\
    %
    =& \partial_z\phi\partial_x - \partial_x\phi\partial_z
\end{align*}
%





\section{Derivates of the fourier transform}
\label{sec:deriv_of_FT}
By using the definition of the fourier transformed, we have
%
\begin{align*}
    F(x,y,\xi) = \defi{-\infty}{\infty}{f(x,y,z)\exp\L(-2\pi iz\xi\R)}{z}
\end{align*}
%
this gives
%
\begin{align*}
    &\defi{-\infty}{\infty}{\L(\partial_zf[x,y,z]\R)\exp\L(-2\pi iz\xi\R)}{z}\\
%
    =& \defi{-\infty}{\infty}{\partial_z\L(f[x,y,z]\exp\L[-2\pi iz\xi\R]\R)}{z}
     - \defi{-\infty}{\infty}{f(x,y,z)\partial_z\exp\L(-2\pi iz\xi\R)}{z}\\
%
    =& \L(f[x,y,z]\exp\L[-2\pi iz\xi\R]\R)\bigg|_{-\infty}^{\infty}
     - \L(-2\pi i\xi\R)\defi{-\infty}{\infty}{f(x,y,z)\exp\L(-2\pi iz\xi\R)}{z}\\
%
    =& 2\pi i\xi F(x,y,\xi)
    \numberthis
    \label{eq:f_derivative}
\end{align*}
%
where we have used that $f(x,y,\pm\infty)=0$ in order to have a well defined
fourier transform. This means that
%
\begin{align*}
    \partial_z^n F(x,y,\xi) = (2\pi i \xi)^n F(x,y,\xi)
\end{align*}
%
In our case, we are dealing with periodic boundary conditions. Strictly
speaking, the fourier transform does not exist in such cases, but it is
possible to define a fourier transform in the limit which in the end lead to
the fourier series%
\footnote{For more detail see Bracewell, R. N. - The Fourier Transform and Its
Applications 3rd Edition chapter $10$}%
%
By discretizing the spatial domain, it is no longer possible to represent the
infinite amount of fourier modes, but only $N+1$ number of modes, where $N$ is
the number of points (this includes the modes with negative frequencies, and
the zeroth offset mode). For the discrete fourier transform, we have
%
\begin{align}
    F(x,y)_{k} =
    \frac{1}{N}\sum_{Z=0}^{N-1}f(x,y)_{Z}\exp\L(\frac{-2\pi i k Z}{N}\R)
    \label{eq:DFT}
\end{align}
%
where $k$ is the mode number, $N$ is the number of points in $z$. If we call
the sampling points of $z$ for $z_Z$, where $Z = 0, 1 \ldots N-1$, we have
that $z_Z = Z \text{d}z$. As our domain goes from $[0, 2\pi[$, we have that
(since we have one less line segment than point) $\text{d}z (N-1) = L_z
= 2\pi - \text{d}z$, which gives $\text{d}z = \frac{2\pi}{N}$. Inserting this
is equation (\ref{eq:DFT}) yields
%
\begin{align*}
    F(x,y)_{k}
    = \frac{1}{N}\sum_{Z=0}^{N-1}f(x,y)_{Z}\exp\L( - i k Z\text{d}z\R)
    = \frac{1}{N}\sum_{Z=0}^{N-1}f(x,y)_{Z}\exp\L( - i k z_Z\R)
\end{align*}
%
The discrete verison of equation (\ref{eq:f_derivative}) thus gives
%
\begin{align*}
    \partial_z^n F(x,y)_k = (i k)^n F(x,y)_k
\end{align*}
%






\section{Divergence of ExB velocity}
%
\begin{align*}
\ve{v}_{ExB} = \frac{\ve{b}\times\nabla\phi}{B}
\end{align*}
%
Using
%
\begin{align*}
\nabla\cdot\L(\ve{F}\times\ve{G}\R) =
\L(\nabla\times\ve{F}\R)\cdot\ve{G} -
\ve{F}\cdot\L(\nabla\times\ve{G}\R)
\end{align*}
%
the divergence of the $\ve{E}\times\ve{B}$ velocity can be written as
%
\begin{align}
\nabla\cdot\L(\frac{1}{B}\ve{b}\times\nabla\phi\R) =
\L[\nabla\times\L(\frac{1}{B}\ve{b}\R)\R]\cdot\nabla\phi -
\frac{1}{B}\ve{b}\cdot\nabla\times\nabla\phi
\label{eq:exb1}
\end{align}
%
The second term on the right is identically zero (curl of a nablaient). The
first term on the right can be expanded as
%
\begin{align*}
\L[\nabla\times\L(\frac{1}{B}\ve{b}\R)\R]\cdot\nabla\phi =
\L[\nabla\L(\frac{1}{B}\R)\times\ve{b} +
\frac{1}{B}\nabla\times\ve{b}\R]\cdot\nabla\phi
\end{align*}
%
Using
%
\begin{align*}
\ve{b}\times\ve{\kappa} = \nabla\times\ve{b} -
\ve{b}\L[\ve{b}\cdot\L(\nabla\times\ve{b}\R)\R]
\end{align*}
%
this becomes:
%
\begin{align*}
  \nabla\cdot\L(\frac{1}{B}\ve{b}\times\nabla\phi\R) =
  &-\ve{b}\times\nabla\L(\frac{1}{B}\R)\cdot\nabla\phi \\ &+
  \frac{1}{B}\ve{b}\times\ve{\kappa}\cdot\nabla\phi \\ &+
  \L[\ve{b}\cdot\L(\nabla\times\ve{b}\R)\R]\ve{b}\cdot\nabla\phi
\end{align*}
%
Alternatively, equation~\ref{eq:exb1} can be expanded as
%
\begin{align*}
  \nabla\cdot\L(\frac{1}{B}\ve{b}\times\nabla\phi\R) =&
    -B\ve{b}\times\nabla\L(\frac{1}{B^2}\R)\cdot\nabla\phi +
    \frac{1}{B^2}\nabla\times\ve{B}\cdot\nabla\phi \\ =&
    -B\ve{b}\times\nabla\L(\frac{1}{B^2}\R)\cdot\nabla\phi +
    \frac{1}{B^2}\ve{J}\cdot\nabla\phi
\end{align*}
%
\end{document}
